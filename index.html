<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - AIIT.support</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root { --font-inter: 'Inter', sans-serif; }
    body { font-family: var(--font-inter); }
    .break-words { word-break: break-word; }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    .safe-bottom { padding-bottom: max(0.5rem, env(safe-area-inset-bottom)); }
    .safe-top { padding-top: max(0.5rem, env(safe-area-inset-top)); }
    textarea { resize: vertical; }
    #previewInvoiceBtn.active { background-color: #d1fae5; color: #047857; }
    
    /* Hide the default calendar icon */
    input[type="date"]::-webkit-calendar-picker-indicator {
      display: none;
      -webkit-appearance: none;
    }

    /* --- [MODIFIED] Step 2: Make inputs invisible --- */
    .invisible-input, .invisible-input:focus {
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      appearance: none !important;
      background-color: transparent !important;
      resize: none !important;
      padding-left: 0 !important;
      padding-right: 0 !important;
    }
    /* Special handling for the invoice number's hash */
    #invoiceNumber.invisible-input {
      padding-left: 1.25rem !important; /* Keep padding for the '#' */
    }
    /* Special handling for the date input's icon */
    #dateIssued.invisible-input {
        padding-left: 2.5rem !important; /* Keep padding for the icon */
        padding-right: 0.75rem !important; /* Restore right padding */
    }
    /* [REMOVED] .address-label rule was here */
    /* --- [END MODIFIED] --- */

  </style>
</head>
<body class="bg-stone-100 p-4 sm:p-6 lg:p-8 safe-top safe-bottom">

  <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden">

    <div class="border-b border-stone-200">

      <div class="flex justify-end p-4 gap-3">
        <button id="newInvoiceBtn" type="button" class="bg-white hover:bg-stone-100 text-stone-700 w-10 h-10 rounded-full transition-colors flex items-center justify-center shadow-lg border border-stone-200" aria-label="New Invoice" title="New Invoice">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v4h4a1 1 0 110 2h-4v4a1 1 0 11-2 0v-4H5a1 1 0 110-2h4V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>
        </button>
        <button id="previewInvoiceBtn" type="button" class="bg-white hover:bg-stone-100 text-stone-700 w-10 h-10 rounded-full transition-colors flex items-center justify-center shadow-lg border border-stone-200 active" aria-label="Toggle Preview" title="Preview invoice" aria-pressed="true">
          <svg id="preview-icon-eye" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 hidden"> <path d="M10 12.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"/> <path fill-rule="evenodd" d="M.664 10.59a1.651 1.651 0 010-1.18l.877-.558a.825.825 0 01.996.066l.742.662a.824.824 0 001.076 0l.742-.662a.825.825 0 01.996-.066l.877.558a1.651 1.651 0 010 1.18l-.877.558a.825.825 0 01-.996.066l-.742-.662a.824.824 0 00-1.076 0l-.742.662a.825.825 0 01-.996-.066l-.877-.558zM17.476 9.41a1.651 1.651 0 010 1.18l-.877.558a.825.825 0 01-.996.066l-.742-.662a.824.824 0 00-1.076 0l-.742.662a.825.825 0 01-.996.066l-.877-.558a1.651 1.651 0 010-1.18l.877-.558a.825.825 0 01.996-.066l.742.662a.824.824 0 001.076 0l.742.662a.825.825 0 01.996.066l.877.558z" clip-rule="evenodd"/> </svg>
          <svg id="preview-icon-eye-slash" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"> <path fill-rule="evenodd" d="M3.28 2.22a.75.75 0 00-1.06 1.06l14.5 14.5a.75.75 0 101.06-1.06l-1.745-1.745a10.029 10.029 0 003.3-4.38 1.651 1.651 0 000-1.18l-.877-.558a.825.825 0 00-.996.066l-.74.659a.824.824 0 01-1.076 0l-.74-.659a.825.825 0 00-.996-.066l-.877.558a1.651 1.651 0 000 1.18l.877.558a.825.825 0 01.996.066l.484.43a6.938 6.938 0 01-5.132 2.131A6.938 6.938 0 014.1 11.03l-.75-.66a.825.825 0 00-.996-.066l-.877.558a1.651 1.651 0 000 1.18l.877.558a.825.825 0 01.996.066l1.916 1.7-.863.764a.824.824 0 01-1.076 0l-.74-.659a.825.825 0 00-.996-.066l-.877.558a1.651 1.651 0 000 1.18l.877.558a.825.825 0 01.996.066l.74.659a.824.824 0 001.076 0l11.16-9.871L3.28 2.22zM8.38 8.38a2.5 2.5 0 003.24 3.24l-3.24-3.24zM10 12.5a2.5 2.5 0 110-5 2.5 2.5 0 010 5z" clip-rule="evenodd"/></svg>
        </button>
        <button id="exportPdfBtn" type="button" class="bg-teal-600 hover:bg-teal-700 text-white w-10 h-10 rounded-full transition-colors flex items-center justify-center shadow-lg border border-stone-200" aria-label="Export as PDF" title="Export as PDF">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
        </button>
      </div>

      <div class="flex items-start justify-between px-6 pb-6">
        <div class="flex-1 pt-2">
          <div class="text-2xl font-bold text-stone-800 flex items-center">
            <input id="logo-part1" type="text" maxlength="10" class="invisible-input text-teal-600 font-bold w-auto" style="min-width: 2ch; max-width: 10ch;" />
            <input id="logo-part2" type="text" maxlength="10" class="invisible-input text-stone-800 font-bold w-auto" style="min-width: 2ch; max-width: 10ch;" />
          </div>
        </div>
        <div class="flex-1 flex justify-end">
          <div class="flex flex-col items-end gap-y-2">
            
            <div class="flex items-center gap-x-2">
              <label for="invoiceNumber" class="text-sm font-bold uppercase text-stone-700 text-right">INVOICE:</label>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-stone-500">#</span>
                <input id="invoiceNumber" type="text" maxlength="8" class="invisible-input font-bold w-28 rounded-md border-stone-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 py-1 pr-3 pl-7" />
              </div>
            </div>
            
            <div class="flex items-center gap-x-2">
              <label for="dateIssued" class="text-sm font-bold uppercase text-stone-700 text-right whitespace-nowrap">DATE ISSUED:</label>
              <div class="relative">
                <button type="button" class="absolute inset-y-0 left-0 flex items-center pl-3 text-stone-500 cursor-pointer" onclick="document.getElementById('dateIssued').showPicker()" aria-label="Open calendar">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                    <path fill-rule="evenodd" d="M5.75 3a.75.75 0 01.75.75v.25h7V3.75a.75.75 0 011.5 0V4h.25A2.75 2.75 0 0118 6.75v8.5A2.75 2.75 0 0115.25 18H4.75A2.75 2.75 0 012 15.25v-8.5A2.75 2.75 0 014.75 4H5v-.25A.75.75 0 015.75 3zM4.5 6.75A1.25 1.25 0 003.25 8v7.25c0 .69.56 1.25 1.25 1.25h10.5c.69 0 1.25-.56 1.25-1.25V8c0-.69-.56-1.25-1.25-1.25H4.5z" clip-rule="evenodd" />
                  </svg>
                </button>
                <input id="dateIssued" type="date" class="invisible-input font-bold uppercase w-full text-right rounded-md border-stone-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 py-1 pr-3 pl-10 cursor-pointer" />
              </div>
            </div>

          </div>
        </div>
      </div>
      
      <div class="p-6 border-t border-stone-200">
        <div class="grid grid-cols-2 gap-6">
          
          <div class="min-w-[12rem] self-start grid grid-cols-[auto,1fr] items-start gap-x-2 gap-y-1">
            <label for="from-line1" class="block text-sm font-bold text-teal-600 whitespace-nowrap pt-1 text-right">FROM:</label>
            <input id="from-line1" type="text" class="invisible-input font-bold block w-full rounded-md py-1 px-3" />
            
            <label for="from-rest" class="block">&nbsp;</label> <textarea id="from-rest" rows="2" class="invisible-input block w-full rounded-md py-1 px-3"></textarea>
          </div>
          
          <div class="min-w-[12rem] self-start grid grid-cols-[auto,1fr] items-start gap-x-2 gap-y-1">
            <label for="client-line1" class="block text-sm font-bold text-teal-600 whitespace-nowrap pt-1 text-right">BILL TO:</label>
            <input id="client-line1" type="text" required class="invisible-input font-bold block w-full rounded-md py-1 px-3" />
            
            <label for="client-rest" class="block">&nbsp;</label> <textarea id="client-rest" rows="2" required class="invisible-input block w-full rounded-md py-1 px-3"></textarea>
          </div>

        </div>
      </div>
    </div>
    
    <main class="p-6">
      <section class="overflow-x-auto border border-stone-200 rounded-lg">
        <table id="invoiceTable" class="min-w-full table-fixed divide-y divide-stone-200">
          <colgroup>
            <col>
            <col class="w-[8ch]">
            <col class="w-[7ch]">
            <col class="w-[9ch]">
            <col class="w-[44px]">
          </colgroup>
          <thead class="bg-teal-600">
             <tr>
              <th scope="col" class="px-4 py-2 text-left    text-xs font-medium text-white uppercase tracking-wider">Description of Work</th>
              <th scope="col" class="px-4 py-2 text-right   text-xs font-medium text-white uppercase tracking-wider whitespace-nowrap">QTY / HRS</th>
              <th scope="col" class="px-2 py-2 text-right   text-xs font-medium text-white uppercase tracking-wider">RATE</th>
              <th scope="col" class="px-2 py-2 text-right   text-xs font-medium text-white uppercase tracking-wider">TOTAL</th>
              <th scope="col" class="px-2 py-2 text-center text-xs font-medium text-white uppercase tracking-wider"></th>
            </tr>
          </thead>
          <tbody class="divide-y divide-stone-200"></tbody>
          <tfoot class="bg-stone-50">
            <tr class="border-t-2 border-stone-300">
              <td colspan="3" class="px-4 py-2 text-right font-bold text-stone-900">Total Amount Due:</td>
              <td class="px-2 py-2 whitespace-nowrap font-bold text-stone-900 text-right text-lg">
                <span id="grandTotalCell"></span>
              </td>
              <td></td> </tr>
          </tfoot>
        </table>
      </section>
    </main>
    
    <footer class="bg-stone-50 p-6 border-t border-stone-200">
        <section class="grid grid-cols-[auto,1fr] items-start gap-x-2">
          <label for="notes" class="block text-sm font-bold text-stone-700 whitespace-nowrap pt-2 text-right">Notes / Payment Terms:</label>
          <textarea id="notes" rows="1" class="invisible-input block w-full h-auto overflow-auto whitespace-pre-wrap rounded-md border-stone-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 px-3 py-2"></textarea>
        </section>
    </footer>

  </div> <script>
    document.addEventListener('DOMContentLoaded', () => {
      // [MODIFIED] Updated element IDs
      const clientLine1 = document.getElementById('client-line1');
      const clientRest = document.getElementById('client-rest');
      const fromLine1 = document.getElementById('from-line1');
      const fromRest = document.getElementById('from-rest');
      const logoPart1 = document.getElementById('logo-part1');
      const logoPart2 = document.getElementById('logo-part2');

      const invoiceTableBody = document.querySelector('#invoiceTable tbody');
      const grandTotalCell = document.getElementById('grandTotalCell');
      const invoiceNumberInput = document.getElementById('invoiceNumber');
      const dateIssuedInput = document.getElementById('dateIssued');
      const notesInput = document.getElementById('notes');
      const exportPdfBtn = document.getElementById('exportPdfBtn');
      const newInvoiceBtn = document.getElementById('newInvoiceBtn');
      const previewInvoiceBtn = document.getElementById('previewInvoiceBtn');
      const eyeIcon = document.getElementById('preview-icon-eye');
      const eyeSlashIcon = document.getElementById('preview-icon-eye-slash');

      (function runSelfTests(){
        console.assert(!!invoiceTableBody, 'invoiceTableBody missing');
        // [MODIFIED] Updated assertion
        console.assert(!!fromLine1 && !!fromRest && !!clientLine1 && !!clientRest, 'address fields missing');
        console.assert(!!logoPart1 && !!logoPart2, 'logo fields missing');
        console.assert(!!invoiceNumberInput, 'invoiceNumberInput missing');
        console.assert(!!dateIssuedInput, 'dateIssuedInput missing');
        console.assert(!!exportPdfBtn && !!newInvoiceBtn, 'header buttons missing');
        console.assert(!!previewInvoiceBtn, 'preview button missing');
      })();

      let invoiceData = [];
      let isPreviewMode = true;
      let activeEditIndex = 0; 

      Object.defineProperty(window, 'invoiceData', {
        configurable: true,
        get: () => invoiceData,
        set: v => { invoiceData = Array.isArray(v) ? v : []; renderInvoice(); }
      });

      function formatCurrency(amount) {
        const num = Number.isFinite(Number(amount)) ? Number(amount) : 0;
        return num.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function getTodayDateString() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      function autoResizeTextarea(el) {
        if (!el) return;
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
      }

      // --- [NEW] Function to auto-resize input width ---
      function autoResizeInput(el) {
        if (!el) return;
        const value = el.value || el.placeholder || '';
        const minWidth = 2; // minimum characters
        const width = Math.max(minWidth, value.length);
        el.style.width = width + 'ch';
      }

      // --- [NEW] Function to split address for new inputs ---
      function splitAddress(fullAddress) {
        const lines = (fullAddress || '').split('\n');
        const firstLine = lines.shift() || '';
        const rest = lines.join('\n');
        return [firstLine, rest];
      }

      // --- [NEW] Function to sync address textareas ---
      function syncTextareaHeights() {
          if (!fromRest || !clientRest) return;
          // Temporarily reset heights to get natural scrollHeight
          fromRest.style.height = 'auto';
          clientRest.style.height = 'auto';
          
          const fromHeight = fromRest.scrollHeight;
          const clientHeight = clientRest.scrollHeight;
          
          const maxHeight = Math.max(fromHeight, clientHeight, 28); // 28px min height
          
          fromRest.style.height = maxHeight + 'px';
          clientRest.style.height = maxHeight + 'px';
      }

      function defaultFirstRow() { return { description: 'Products & Services', quantity: 6.0, unit: 'Hrs', rate: 75.00, total: 6.0 * 75.00, isPayment: false }; }

      const DEFAULT_NOTES = 'Thank you for your business!';
      function migrateNotes(val) {
        const s = String(val || '').trim();
        const lower = s.toLowerCase();
        if (!s) return DEFAULT_NOTES;
        if (lower === 'payment is due within 15 days.' || lower === 'payment is due within 15 days') return DEFAULT_NOTES;
        return s;
      }
      function setNotes(value) {
        const n = document.getElementById('notes');
        if (n) n.value = migrateNotes(value);
      }

      const TIMEOUT_MS = 4000;
      function withTimeout(promise, ms = TIMEOUT_MS) {
        return Promise.race([
          promise,
          new Promise((_, rej) => setTimeout(() => rej(new Error('Request timeout')), ms))
        ]);
      }
      async function fetchJson(url, options) {
        try {
          const res = await withTimeout(fetch(url, options));
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const ct = res.headers.get('content-type') || '';
          if (!ct.includes('application/json')) throw new Error('Invalid content-type');
          return await res.json();
        } catch (e) { console.warn('fetchJson failed:', e?.message || e); return null; }
      }
      async function postJson(url, body) {
        try { await withTimeout(fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })); }
        catch (e) { console.warn('postJson failed:', e?.message || e); }
      }

      const api = { getInvoice: () => fetchJson('/api/invoices'), saveInvoice: (payload) => postJson('/api/invoices', payload) };

      // [MODIFIED] To handle new address fields and logo
      function setGlobalDefaults() {
        if (invoiceNumberInput) invoiceNumberInput.value = localStorage.getItem('lastInvoiceNumber') || '001';

        logoPart1.value = localStorage.getItem('logoPart1') || 'AI';
        logoPart2.value = localStorage.getItem('logoPart2') || 'IT.';
        autoResizeInput(logoPart1);
        autoResizeInput(logoPart2);

        const [from1, fromRestVal] = splitAddress(localStorage.getItem('lastFrom') || 'Your Company, Inc.');
        fromLine1.value = from1;
        fromRest.value = fromRestVal;

        const [client1, clientRestVal] = splitAddress(localStorage.getItem('lastClient') || 'Customer Name');
        clientLine1.value = client1;
        clientRest.value = clientRestVal;

        setNotes(localStorage.getItem('lastNotes') || '');
        dateIssuedInput.value = getTodayDateString();
      }

      // [MODIFIED] To handle new address fields and logo
      function ensureDefaults() {
        if (invoiceNumberInput && !invoiceNumberInput.value) invoiceNumberInput.value = localStorage.getItem('lastInvoiceNumber') || '001';

        if (!logoPart1.value) {
            logoPart1.value = localStorage.getItem('logoPart1') || 'AI';
            autoResizeInput(logoPart1);
        }
        if (!logoPart2.value) {
            logoPart2.value = localStorage.getItem('logoPart2') || 'IT.';
            autoResizeInput(logoPart2);
        }

        if (!fromLine1.value && !fromRest.value) {
            const [from1, fromRestVal] = splitAddress(localStorage.getItem('lastFrom') || 'Your Company, Inc.');
            fromLine1.value = from1;
            fromRest.value = fromRestVal;
        }
        if (!clientLine1.value && !clientRest.value) {
            const [client1, clientRestVal] = splitAddress(localStorage.getItem('lastClient') || 'Customer Name');
            clientLine1.value = client1;
            clientRest.value = clientRestVal;
        }

        const n = document.getElementById('notes');
        if (n && !n.value)          setNotes(localStorage.getItem('lastNotes') || '');
        if (!dateIssuedInput.value)     dateIssuedInput.value   = getTodayDateString();
        if (!invoiceData || invoiceData.length === 0) invoiceData = [ defaultFirstRow() ];
      }

      // [MODIFIED] To handle new address fields
      async function initializeDashboard() {
        try {
          const savedInvoice = await api.getInvoice();
          if (savedInvoice && typeof savedInvoice === 'object' && (savedInvoice.invoiceNumber || (Array.isArray(savedInvoice.items) && savedInvoice.items.length))) {
            if (invoiceNumberInput) invoiceNumberInput.value = savedInvoice.invoiceNumber || '';
            
            const [from1, fromRestVal] = splitAddress(savedInvoice.contractorName);
            fromLine1.value = from1;
            fromRest.value = fromRestVal;
            
            const [client1, clientRestVal] = splitAddress(savedInvoice.client);
            clientLine1.value = client1;
            clientRest.value = clientRestVal;

            setNotes(savedInvoice.notes || '');
            invoiceData = Array.isArray(savedInvoice.items) ? savedInvoice.items : [];
          } else {
            setGlobalDefaults();
            try { invoiceData = JSON.parse(localStorage.getItem('lastInvoiceData') || '[]'); } catch { invoiceData = []; }
          }
        } catch (error) {
          console.error('initializeDashboard hard failure:', error);
          setGlobalDefaults();
          try { invoiceData = JSON.parse(localStorage.getItem('lastInvoiceData') || '[]'); } catch { invoiceData = []; }
        } finally {
          try { 
            ensureDefaults(); 
            activeEditIndex = 0; // Ensure editor starts at row 0
            renderInvoice(); 
            saveInvoiceData(); 
            syncTextareaHeights(); // Sync heights on load
          }
          catch (e) { console.error('Finalization error:', e); }
        }
      }

      let saveDebounceId; function saveInvoiceData() { if (saveDebounceId) clearTimeout(saveDebounceId); saveDebounceId = setTimeout(_saveInvoiceData, 250); }
      
      // [MODIFIED] To handle new address fields and logo
      function _saveInvoiceData() {
        const n = document.getElementById('notes');
        const canonicalNotes = migrateNotes(n ? n.value : '');
        if (n) n.value = canonicalNotes;

        const contractorName = (fromLine1.value + '\n' + fromRest.value).trim();
        const clientName = (clientLine1.value + '\n' + clientRest.value).trim();

        try {
          if (invoiceNumberInput) localStorage.setItem('lastInvoiceNumber', invoiceNumberInput.value);
          localStorage.setItem('logoPart1', logoPart1.value);
          localStorage.setItem('logoPart2', logoPart2.value);
          localStorage.setItem('lastFrom', contractorName);
          localStorage.setItem('lastClient', clientName);
          localStorage.setItem('lastNotes', canonicalNotes);
          localStorage.setItem('lastInvoiceData', JSON.stringify(invoiceData));
        } catch (e) { console.warn('localStorage save failed', e); }
        
        const payload = { 
            invoiceNumber: invoiceNumberInput ? invoiceNumberInput.value : '', 
            contractorName: contractorName, 
            client: clientName, 
            notes: canonicalNotes, 
            items: invoiceData 
        };
        api.saveInvoice(payload);
      }

      function updateGrandTotal() {
        const grandTotal = invoiceData.reduce((s, it) => s + (Number(it.total) || 0), 0);
        const formatted = formatCurrency(grandTotal);
        // --- [FIXED LINE] ---
        // Show formatted currency when preview is ON (true), hide it ('***') when preview is OFF (false)
        grandTotalCell.textContent = isPreviewMode ? formatted : '***';
        // --- [END FIXED LINE] ---
        grandTotalCell.setAttribute('data-actual', formatted);
      }

      function cloneEntry(e) { return { description: e.description, quantity: e.quantity, unit: e.unit, rate: e.rate, total: e.total, isPayment: e.isPayment || false }; }
      function parseTimeToDecimal(t) { if (!t) return 0; if (!String(t).includes(':')) { const n = parseFloat(t); return Number.isFinite(n) ? n : 0; } const [h,m]=String(t).split(':'); return (parseInt(h,10)||0)+((parseInt(m,10)||0)/60); }
      function tdText(cls, text) { const td=document.createElement('td'); td.className=cls; td.textContent=text; return td; }
      function parseQtyInput(val, unit) { return unit === 'Hrs' ? parseTimeToDecimal(val) : (parseInt(val, 10) || 0); }
      
      // --- [MODIFIED] Uses generic 'edit-rate' ID ---
      function commitRateFromInput() {
        const rateEl = document.getElementById('edit-rate'); // Use generic ID
        if (!rateEl) return;

        // If the element is active, its value is raw. Commit it to dataset.
        if (document.activeElement === rateEl) {
             const raw = (rateEl.value || '').replace(/[^0-9.]/g, '');
             const numeric = parseFloat(raw);
             rateEl.dataset.actual = (Number.isFinite(numeric) ? numeric : 0).toFixed(2);
        } else {
            // If element is not active, its value is already a display value ('**' or '$').
            // We must check if that display value has been manually changed (e.g., user typed and clicked away)
            const displayValue = isPreviewMode ? formatCurrency(parseFloat(rateEl.dataset.actual || '0') || 0) : '**';
            if (rateEl.value !== displayValue) {
                // User typed something and blurred.
                const raw = (rateEl.value || '').replace(/[^0-9.]/g, '');
                const numeric = parseFloat(raw);
                rateEl.dataset.actual = (Number.isFinite(numeric) ? numeric : 0).toFixed(2);
            }
        }
        
        // Finally, set the display value
        rateEl.value = isPreviewMode ? formatCurrency(parseFloat(rateEl.dataset.actual || '0') || 0) : '**';
      }

      // --- [NEW] Saves data from active editor to invoiceData array ---
      function commitActiveEditor() {
          if (activeEditIndex === null || !invoiceData[activeEditIndex]) return;

          const entry = invoiceData[activeEditIndex];
          const descEl = document.getElementById('edit-desc');
          const totalEl = document.getElementById('edit-total');

          if (!descEl) {
             // Editor wasn't rendered (e.g., on initial load), so nothing to commit.
             return;
          }

          entry.description = descEl.value;

          if (entry.isPayment) {
              // Payment mode: commit the total value directly
              if (totalEl && totalEl.tagName === 'INPUT') {
                  const raw = (totalEl.value || '').replace(/[^0-9.\-]/g, '');
                  const numeric = parseFloat(raw);
                  entry.total = Number.isFinite(numeric) ? numeric : 0;
              }
              entry.quantity = 0;
              entry.rate = 0;
          } else {
              // Normal mode: calculate total from qty and rate
              const qtyEl  = document.getElementById('edit-qty');
              const rateEl = document.getElementById('edit-rate');

              if (!qtyEl || !rateEl) {
                 return;
              }

              entry.quantity = parseQtyInput(qtyEl.value, entry.unit);

              // Commit rate from its dataset
              commitRateFromInput(); // This will fix the input's value AND update dataset.actual
              entry.rate = parseFloat(rateEl.dataset.actual || '0') || 0;

              entry.total = entry.quantity * entry.rate;
          }
          saveInvoiceData();
      }

      // --- [NEW] Handles live typing in the active editor ---
      function recalcAndPersistActiveRow() {
          // This function is for live updates *while typing*
          if (activeEditIndex === null || !invoiceData[activeEditIndex]) return;

          const row = invoiceData[activeEditIndex];
          const descEl = document.getElementById('edit-desc');
          const qtyEl  = document.getElementById('edit-qty');
          const rateEl = document.getElementById('edit-rate');
          const totalEl = document.getElementById('edit-total');

          if (!descEl || !totalEl) return;

          row.description = descEl.value;

          // If in payment mode, get total directly from input
          if (row.isPayment) {
              if (totalEl.tagName === 'INPUT') {
                  const raw = (totalEl.value || '').replace(/[^0-9.\-]/g, '');
                  const n = parseFloat(raw);
                  row.total = Number.isFinite(n) ? n : 0;
              } else {
                  // totalEl is a span, shouldn't happen in payment mode
                  row.total = parseFloat(totalEl.textContent.replace(/[^0-9.\-]/g, '')) || 0;
              }
              row.quantity = 0;
              row.rate = 0;
          } else {
              // Normal calculation mode
              if (!qtyEl || !rateEl) return;

              row.quantity = parseQtyInput(qtyEl.value, row.unit);

              // Rate logic for live update
              if (document.activeElement === rateEl) {
                  const raw = (rateEl.value || '').replace(/[^0-9.]/g, '');
                  const n = parseFloat(raw);
                  row.rate = Number.isFinite(n) ? n : 0;
                  rateEl.dataset.actual = row.rate.toFixed(2); // Update dataset live
              } else {
                  // If rate is not active, its value is driven by dataset.actual
                  row.rate = parseFloat(rateEl.dataset.actual || '0') || 0;
              }

              row.total = row.quantity * row.rate;
          }

          // Update display
          if (totalEl.tagName === 'INPUT') {
              // Don't update while user is typing in it
              if (document.activeElement !== totalEl) {
                  totalEl.value = isPreviewMode ? formatCurrency(row.total) : '**';
              }
          } else {
              totalEl.textContent = isPreviewMode ? formatCurrency(row.total) : '**';
          }
          updateGrandTotal();
          saveInvoiceData();
      }

      // --- [HEAVILY MODIFIED] ---
      function renderInvoice() {
        invoiceTableBody.innerHTML = '';
        
        invoiceData.forEach((entry, index) => {
          const newRow = document.createElement('tr');
          newRow.className = (index % 2 !== 0) ? 'bg-stone-50' : 'bg-white';

          const qtyDisplay = entry.unit === 'Hrs' ? (Number(entry.quantity) || 0).toFixed(2) : String(parseInt(entry.quantity, 10) || 0);
          const actualRate = (Number(entry.rate) || 0);
          const actualTotal = (Number(entry.total) || 0);

          // --- Polarity is: Preview ON (true) = Show Currency, Preview OFF (false) = Show '***' ---
          const rateDisplay = isPreviewMode ? formatCurrency(actualRate) : '**';
          const totalDisplay = isPreviewMode ? formatCurrency(actualTotal) : '**';

          if (index === activeEditIndex) {
            // --- This row IS the active editor ---
            newRow.className += ' shadow-inner-lg';

            const tdDesc = document.createElement('td'); tdDesc.className = 'px-4 py-2';
            const descArea = document.createElement('textarea');
            descArea.id = 'edit-desc';
            descArea.className = 'invisible-input w-full rounded-md border-stone-300 border shadow-sm focus:border-teal-500 focus:ring-teal-500 px-2 py-1 resize-none';
            descArea.rows = 2; descArea.value = entry.description || '';
            tdDesc.appendChild(descArea);

            const tdQty = document.createElement('td'); tdQty.className = 'px-4 py-2 whitespace-nowrap text-right';
            const tdRate = document.createElement('td'); tdRate.className = 'px-2 py-2 whitespace-nowrap text-right';
            const tdTotal = document.createElement('td'); tdTotal.className = 'px-2 py-2 whitespace-nowrap text-right';

            if (entry.isPayment) {
                // PAYMENT MODE: Show disabled QTY/RATE and editable TOTAL
                tdQty.textContent = '—';
                tdQty.className += ' text-stone-400';
                tdRate.textContent = '—';
                tdRate.className += ' text-stone-400';

                const totalInput = document.createElement('input');
                totalInput.id = 'edit-total';
                totalInput.type = 'text';
                totalInput.inputMode = 'decimal';
                totalInput.className = 'invisible-input w-20 text-right rounded-md border-stone-300 border shadow-sm focus:border-teal-500 focus:ring-teal-500 px-2 py-1';
                totalInput.value = isPreviewMode ? formatCurrency(actualTotal) : '**';
                totalInput.dataset.actual = actualTotal.toFixed(2);
                tdTotal.appendChild(totalInput);

                totalInput.addEventListener('focus', () => {
                    const actual = totalInput.dataset.actual || '0.00';
                    totalInput.value = actual;
                    requestAnimationFrame(() => { try { totalInput.select(); } catch {} });
                });
                totalInput.addEventListener('blur', () => {
                    const raw = (totalInput.value || '').replace(/[^0-9.\-]/g, '');
                    let numeric = parseFloat(raw);
                    // Auto-convert positive values to negative for payments
                    if (Number.isFinite(numeric) && numeric > 0) {
                        numeric = -numeric;
                    }
                    totalInput.dataset.actual = (Number.isFinite(numeric) ? numeric : 0).toFixed(2);
                    totalInput.value = isPreviewMode ? formatCurrency(parseFloat(totalInput.dataset.actual)) : '**';
                    recalcAndPersistActiveRow();
                });
                totalInput.addEventListener('input', () => {
                    recalcAndPersistActiveRow();
                });
            } else {
                // NORMAL MODE: Show editable QTY/RATE and calculated TOTAL
                const qtyInput = document.createElement('input');
                qtyInput.id = 'edit-qty';
                qtyInput.setAttribute('inputmode','decimal');
                qtyInput.className = 'invisible-input w-12 text-right rounded-md border-stone-300 border shadow-sm focus:border-teal-500 focus:ring-teal-500 px-2 py-1';
                qtyInput.value = qtyDisplay;
                tdQty.appendChild(qtyInput);

                const rateInput = document.createElement('input');
                rateInput.id = 'edit-rate';
                rateInput.type = 'text';
                rateInput.inputMode = 'decimal';
                rateInput.className = 'invisible-input w-16 text-right rounded-md border-stone-300 border shadow-sm focus:border-teal-500 focus:ring-teal-500 px-2 py-1';
                rateInput.dataset.actual = actualRate.toFixed(2);
                rateInput.value = rateDisplay;
                tdRate.appendChild(rateInput);

                const totalSpan = document.createElement('span');
                totalSpan.id = 'edit-total';
                totalSpan.textContent = totalDisplay;
                tdTotal.appendChild(totalSpan);

                rateInput.addEventListener('focus', () => {
                    const actual = rateInput.dataset.actual || '0.00';
                    rateInput.value = actual;
                    requestAnimationFrame(() => { try { rateInput.select(); } catch {} });
                });
                rateInput.addEventListener('blur', () => {
                    commitRateFromInput();
                    recalcAndPersistActiveRow();
                });
                rateInput.addEventListener('input', () => {
                    recalcAndPersistActiveRow();
                });
                qtyInput.addEventListener('input', () => { recalcAndPersistActiveRow(); });
            }

            const tdActions = document.createElement('td'); tdActions.className = 'px-2 py-2 whitespace-nowrap text-center';

            // Add payment toggle button (dollar sign)
            const toggleBtn = document.createElement('button');
            toggleBtn.className = entry.isPayment
                ? 'toggle-payment-button inline-flex items-center justify-center w-8 h-8 rounded-full bg-green-600 hover:bg-green-700 text-white font-bold text-sm shadow-lg border border-stone-200'
                : 'toggle-payment-button inline-flex items-center justify-center w-8 h-8 rounded-full bg-stone-400 hover:bg-stone-500 text-white font-bold text-sm shadow-lg border border-stone-200';
            toggleBtn.title = entry.isPayment ? 'Switch to normal mode' : 'Record a payment';
            toggleBtn.textContent = '$';
            toggleBtn.dataset.index = index;
            tdActions.appendChild(toggleBtn);

            if (index === 0) {
                const addBtn = document.createElement('button');
                addBtn.className = 'add-button inline-flex items-center justify-center w-8 h-8 rounded-full bg-teal-600 hover:bg-teal-700 text-white font-extrabold text-lg shadow-lg border border-stone-200 ml-1';
                addBtn.title = 'Add row';
                addBtn.textContent = '+';
                tdActions.appendChild(addBtn);
            } else {
                const delBtn = document.createElement('button');
                delBtn.className = 'delete-button inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-600 hover:bg-red-700 text-white font-extrabold text-lg shadow-lg border border-stone-200 ml-1';
                delBtn.title = 'Delete row';
                delBtn.textContent = '−';
                delBtn.dataset.index = index;
                tdActions.appendChild(delBtn);
            }

            newRow.appendChild(tdDesc);
            newRow.appendChild(tdQty);
            newRow.appendChild(tdRate);
            newRow.appendChild(tdTotal);
            newRow.appendChild(tdActions);

            requestAnimationFrame(() => autoResizeTextarea(descArea));
            descArea.addEventListener('input', () => { autoResizeTextarea(descArea); recalcAndPersistActiveRow(); });

          } else {
            // --- This row is STATIC ---
            const tdDesc = tdText('px-4 py-2 text-sm text-stone-900 break-words', String(entry.description || ''));
            tdDesc.dataset.index = index;
            tdDesc.dataset.field = 'description';

            // Show "—" for payment rows
            const tdQty = tdText('px-4 py-2 whitespace-nowrap text-sm text-stone-500 text-right', entry.isPayment ? '—' : qtyDisplay);
            tdQty.dataset.index = index;
            tdQty.dataset.field = 'quantity';

            const tdRate = tdText('px-2 py-2 whitespace-nowrap text-sm text-stone-500 text-right', entry.isPayment ? '—' : rateDisplay);
            tdRate.dataset.index = index;
            tdRate.dataset.field = 'rate';

            const tdTotal = tdText('px-2 py-2 whitespace-nowrap text-sm text-stone-500 text-right', totalDisplay);
            tdTotal.dataset.index = index;
            tdTotal.dataset.field = 'total';

            const tdActions = document.createElement('td');
            tdActions.className = 'px-2 py-2';
            tdActions.dataset.index = index; // Clicking here will also activate the row
            tdActions.dataset.field = 'action';

            newRow.appendChild(tdDesc);
            newRow.appendChild(tdQty);
            newRow.appendChild(tdRate);
            newRow.appendChild(tdTotal);
            newRow.appendChild(tdActions);
          }
          invoiceTableBody.appendChild(newRow);
        });
        
        updateGrandTotal();
        autoResizeTextarea(document.getElementById('notes'));
        // [MODIFIED] Call syncTextareaHeights instead of autoResize
        syncTextareaHeights();
      }

      // --- [DELETED] attachFirstRowEditors() function was here ---

      // --- [HEAVILY MODIFIED] ---
      invoiceTableBody.addEventListener('click', function(event) {
        const addBtn = event.target.closest('.add-button');
        const delBtn = event.target.closest('.delete-button');
        const editableCell = event.target.closest('td[data-index]');

        if (addBtn) {
          // --- Logic for ADDING a row ---
          // This button only exists when activeEditIndex is 0.

          commitActiveEditor(); // Save current data from row 0

          const entryToAdd = invoiceData[0]; // The entry is already saved

          // Check for empty description
          if (!entryToAdd.description || entryToAdd.description.trim() === "") {
              entryToAdd.description = "Products & Services";
          }

          invoiceData.splice(1, 0, cloneEntry(entryToAdd)); // Insert a *copy*
          invoiceData[0] = defaultFirstRow(); // Reset the first row to defaults
          activeEditIndex = 0; // Keep editor on the new first row

          renderInvoice();
          saveInvoiceData(); // Save the updated array

          const firstDesc = document.getElementById('edit-desc');
          if (firstDesc) {
              requestAnimationFrame(() => firstDesc.focus());
           }
          return;
        }

        if (delBtn) {
          // --- Logic for DELETING a row ---
          const index = parseInt(delBtn.dataset.index, 10);

          // Remove the row from invoiceData
          invoiceData.splice(index, 1);

          // Ensure there's always at least one row
          if (invoiceData.length === 0) {
              invoiceData = [ defaultFirstRow() ];
          }

          // Move editor back to row 0
          activeEditIndex = 0;

          renderInvoice();
          saveInvoiceData();

          const firstDesc = document.getElementById('edit-desc');
          if (firstDesc) {
              requestAnimationFrame(() => firstDesc.focus());
          }
          return;
        }

        const toggleBtn = event.target.closest('.toggle-payment-button');
        if (toggleBtn) {
          // --- Logic for TOGGLING payment mode ---
          const index = parseInt(toggleBtn.dataset.index, 10);

          // Commit current editor state
          commitActiveEditor();

          // Toggle the payment mode
          invoiceData[index].isPayment = !invoiceData[index].isPayment;

          // If switching to payment mode, clear qty/rate and set total to 0 (or keep existing total)
          if (invoiceData[index].isPayment) {
              // Keep the current total if it exists, otherwise set to 0
              if (!invoiceData[index].total) {
                  invoiceData[index].total = 0;
              }
              invoiceData[index].quantity = 0;
              invoiceData[index].rate = 0;
          } else {
              // Switching back to normal mode - restore default values if needed
              if (!invoiceData[index].quantity && !invoiceData[index].rate) {
                  invoiceData[index].quantity = 1;
                  invoiceData[index].rate = 0;
                  invoiceData[index].total = 0;
              }
          }

          // Stay on the same row
          activeEditIndex = index;

          renderInvoice();
          saveInvoiceData();

          // Focus the appropriate field
          if (invoiceData[index].isPayment) {
              const totalInput = document.getElementById('edit-total');
              if (totalInput) {
                  requestAnimationFrame(() => totalInput.focus());
              }
          } else {
              const descArea = document.getElementById('edit-desc');
              if (descArea) {
                  requestAnimationFrame(() => descArea.focus());
              }
          }
          return;
        }

        if (editableCell) {
            const index = parseInt(editableCell.dataset.index, 10);
            if (index === activeEditIndex) return; // Already editing this row

            // --- Logic for SWITCHING editor row ---
            commitActiveEditor(); // Save data from the previously active row

            activeEditIndex = index; // Set the new active row
            renderInvoice(); // Re-render the table

            // Find the newly created input and focus it
            const field = editableCell.dataset.field;
            let inputToFocus;
            if (field === 'description') {
                inputToFocus = document.getElementById('edit-desc');
            } else if (field === 'quantity') {
                inputToFocus = document.getElementById('edit-qty');
            } else if (field === 'rate') {
                inputToFocus = document.getElementById('edit-rate');
            }
            
            if (inputToFocus) {
                 requestAnimationFrame(() => {
                    inputToFocus.focus();
                    if (inputToFocus.select) inputToFocus.select();
                 });
            }
        }
      });
      // --- [END MODIFIED EVENT LISTENER] ---


      function getPdfA11yEnabled(){ const v = localStorage.getItem('pdfA11yEnabled'); return v === null ? false : v === 'true'; }
      function setPdfA11yEnabled(val){ try { localStorage.setItem('pdfA11yEnabled', String(!!val)); } catch {} }

      dateIssuedInput.addEventListener('change', saveInvoiceData);
      if (notesInput) notesInput.addEventListener('input', () => { autoResizeTextarea(notesInput); saveInvoiceData(); });

      // [MODIFIED] New event listeners for logo fields
      logoPart1.addEventListener('input', () => { autoResizeInput(logoPart1); saveInvoiceData(); });
      logoPart2.addEventListener('input', () => { autoResizeInput(logoPart2); saveInvoiceData(); });

      // [MODIFIED] New event listeners for new fields
      fromLine1.addEventListener('input', saveInvoiceData);
      fromRest.addEventListener('input', () => { syncTextareaHeights(); saveInvoiceData(); });
      clientLine1.addEventListener('input', saveInvoiceData);
      clientRest.addEventListener('input', () => { syncTextareaHeights(); saveInvoiceData(); });

      if (invoiceNumberInput) invoiceNumberInput.addEventListener('input', saveInvoiceData);

      // [MODIFIED] To use new address fields and logo
      function drawPdfHeader(doc, currentY, margin, pageWidth, teal_600, stone_700, invoiceNumber, dateIssued, unused, pdfA11y) {
        // Draw company logo/name
        const logo1 = logoPart1.value || 'AI';
        const logo2 = logoPart2.value || 'IT.';

        doc.setFont('helvetica', 'bold');
        doc.setFontSize(16);
        doc.setTextColor.apply(null, teal_600);
        doc.text(logo1, margin, currentY);

        const logo1Width = doc.getTextWidth(logo1);
        doc.setTextColor.apply(null, stone_700);
        doc.text(logo2, margin + logo1Width, currentY);

        // Draw invoice number and date on the right side
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        doc.setTextColor.apply(null, stone_700);

        const invoiceLabel = 'INVOICE:';
        const invoiceLabelWidth = doc.getTextWidth(invoiceLabel);
        const invoiceValue = '#' + invoiceNumber;

        const dateLabel = 'DATE ISSUED:';
        const dateLabelWidth = doc.getTextWidth(dateLabel);

        // Position invoice number
        const rightX = pageWidth - margin;
        doc.text(invoiceLabel, rightX - doc.getTextWidth(invoiceValue) - doc.getTextWidth(invoiceLabel) - 2, currentY - 6, { align: 'left' });
        doc.setFont('helvetica', 'bold');
        doc.text(invoiceValue, rightX, currentY - 6, { align: 'right' });

        // Position date
        doc.setFont('helvetica', 'bold');
        doc.text(dateLabel, rightX - doc.getTextWidth(dateIssued) - dateLabelWidth - 2, currentY, { align: 'left' });
        doc.setFont('helvetica', 'bold');
        doc.text(dateIssued, rightX, currentY, { align: 'right' });
      }

      function drawPdfAddresses(doc, currentY, margin, halfPageWidth, teal_600, stone_700) {
        const fromVal = (fromLine1.value + '\n' + fromRest.value).trim();
        const clientVal = (clientLine1.value + '\n' + clientRest.value).trim();

        const fromAllLines = fromVal.split('\n'); const fromFirstLine = fromAllLines.shift() || ''; const fromRestOfLinesText = fromAllLines.join('\n');
        const clientAllLines = clientVal.split('\n'); const clientFirstLine = clientAllLines.shift() || ''; const clientRestOfLinesText = clientAllLines.join('\n');

        const labelGap = 2; // Increased gap to 2 spaces
        const columnPadding = 5;
        const addressGap = 1.5;
        const pageWidth = doc.internal.pageSize.getWidth();

        doc.setFont('helvetica', 'bold'); doc.setFontSize(12);

        // --- FROM ---
        const fromLabelText = 'FROM:';
        const fromLabelWidth = doc.getTextWidth(fromLabelText);
        // Align label to the right of its "column" (margin to halfPageWidth - columnPadding)
        const fromLabelX = halfPageWidth - columnPadding - fromLabelWidth; // Right-align label
        const fromDataX = halfPageWidth - columnPadding; // Start data right after
        const fromColumnWidth = halfPageWidth - fromDataX; // This is wrong, let's rethink

        // Simple grid: Label column and Data column
        const fromLabelColWidth = doc.getTextWidth('BILL TO:') + labelGap; // Use widest label for alignment
        const fromLabelColX = margin;
        const fromDataColX = fromLabelColX + fromLabelColWidth;
        const fromDataColWidth = (halfPageWidth - margin) - fromLabelColWidth - columnPadding;

        doc.setTextColor.apply(null, teal_600);
        doc.text(fromLabelText, fromDataColX - labelGap, currentY, { align: 'right' }); // Align right, ending at data start

        let fromBlockY = currentY;
        doc.setFontSize(11); doc.setTextColor.apply(null, stone_700);
        doc.setFont('helvetica', 'bold');
        const splitFirstFrom = doc.splitTextToSize(fromFirstLine, fromDataColWidth);
        doc.text(splitFirstFrom, fromDataColX, fromBlockY, { align: 'left' });

        let fromHeight = doc.getTextDimensions(splitFirstFrom).h;
        fromBlockY += fromHeight;
        doc.setFont('helvetica', 'normal');
        if (fromRestOfLinesText) {
          fromBlockY += addressGap;
          const splitRestFrom = doc.splitTextToSize(fromRestOfLinesText, fromDataColWidth);
          doc.text(splitRestFrom, fromDataColX, fromBlockY, { align: 'left' });
          fromHeight += doc.getTextDimensions(splitRestFrom).h + addressGap;
        }

        // --- BILL TO ---
        doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
        const toLabelText = 'BILL TO:';
        const toLabelColX = halfPageWidth + columnPadding; // Start second column
        const toDataColX = toLabelColX + fromLabelColWidth; // Use same width as 'from' label column
        const toDataColWidth = (pageWidth - margin) - toDataColX;

        doc.setTextColor.apply(null, teal_600);
        doc.text(toLabelText, toDataColX - labelGap, currentY, { align: 'right' }); // Align right

        let clientBlockY = currentY;
        doc.setFontSize(11); doc.setTextColor.apply(null, stone_700);
        doc.setFont('helvetica', 'bold');
        const splitFirstClient = doc.splitTextToSize(clientFirstLine, toDataColWidth);
        doc.text(splitFirstClient, toDataColX, clientBlockY, { align: 'left' });

        let clientHeight = doc.getTextDimensions(splitFirstClient).h;
        clientBlockY += clientHeight;
        doc.setFont('helvetica', 'normal');
        if (clientRestOfLinesText) {
          clientBlockY += addressGap;
          const splitRestClient = doc.splitTextToSize(clientRestOfLinesText, toDataColWidth);
          doc.text(splitRestClient, toDataColX, clientBlockY, { align: 'left' });
          clientHeight += doc.getTextDimensions(splitRestClient).h + addressGap;
        }

        return Math.max(fromHeight, clientHeight);
      }

      function drawPdfFooter(doc, pageNumber, pageCount, margin, pageWidth) {
        doc.setFontSize(9); doc.setTextColor.apply(null, [168, 162, 158]);
        const footerY = doc.internal.pageSize.height - 10;
        const textPart1 = '© 2025 '; const textPart2_link = 'www.AIIT.support'; const textPart3 = '. All Rights Reserved.';
        const textPart1Width = doc.getTextWidth(textPart1); const textPart2Width = doc.getTextWidth(textPart2_link);
        const linkX = margin + textPart1Width;
        doc.text(textPart1, margin, footerY); doc.text(textPart2_link, linkX, footerY); doc.text(textPart3, linkX + textPart2Width, footerY);
        doc.link(linkX, footerY - doc.getFontSize(), textPart2Width, doc.getFontSize(), { url: 'https://www.aiit.support' });
        doc.text('Page ' + pageNumber + ' of ' + pageCount, pageWidth - margin, footerY, { align: 'right' });
      }

      function exportToPdf() {
        if (!Array.isArray(window.invoiceData) || window.invoiceData.length === 0) { 
          // Use a custom modal later
          console.warn('Cannot export an empty invoice.'); 
          return; 
        }

        // --- [NEW] Commit active editor before export ---
        commitActiveEditor();

        const currentInvoiceNumber = invoiceNumberInput ? (invoiceNumberInput.value || '000') : '000';
        const theDate = dateIssuedInput.value || getTodayDateString();
        // Use T00:00:00 to avoid timezone issues
        const dateObj = new Date(theDate + 'T00:00:00');
        const dateIssuedDisp = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });


        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.setProperties({ title: `Invoice ${currentInvoiceNumber}`, subject: "Brand wordmark: www.AIIT.support. Promotional sites: AIIT.support and CustomInvoice.AI.", author: (fromLine1.value || 'AIIT.support'), keywords: 'invoice, AIIT.support, CustomInvoice.AI, billing', creator: 'AIIT Dashboard' });
        const pdfA11y = getPdfA11yEnabled(); const teal_600 = [13, 148, 136]; const stone_700 = [68, 64, 60];
        const pageWidth = doc.internal.pageSize.getWidth(); const margin = 14; const halfPageWidth = pageWidth / 2; let currentY = 22;

        drawPdfHeader(doc, currentY, margin, pageWidth, teal_600, stone_700, currentInvoiceNumber, dateIssuedDisp, undefined, pdfA11y);

        currentY += 18;
        const addressBlockHeight = drawPdfAddresses(doc, currentY, margin, halfPageWidth, teal_600, stone_700);
        let tableStartY = currentY + addressBlockHeight + 10;

        const dataRows = (window.invoiceData || []);
        const rows = dataRows.map(entry => {
            if (entry.isPayment) {
                // Payment row: show description and total only
                return [ String(entry.description || ''), '—', '—', formatCurrency(entry.total) ];
            } else {
                // Normal row: show all fields
                const qtyDisplay = entry.unit === 'Hrs' ? (Number(entry.quantity) || 0).toFixed(2) : (parseInt(entry.quantity, 10) || 0);
                return [ String(entry.description || ''), qtyDisplay, formatCurrency(entry.rate), formatCurrency(entry.total) ];
            }
        });
        const grandTotal = dataRows.reduce((sum, item) => sum + (Number(item.total) || 0), 0);

        if (pdfA11y) { doc.setTextColor(120, 113, 108); doc.setFontSize(8); doc.text('Table: Invoice line items — Description; Qty/Hrs; Rate; Total.', margin, tableStartY - 2); }
        doc.autoTable({
          head: [['Description of Work', 'QTY / HRS', 'RATE', 'TOTAL']],
          body: rows,
          startY: tableStartY,
          headStyles: { fillColor: teal_600, textColor: [255, 255, 255] },
          foot: [[{ content: 'Total Amount Due:', colSpan: 3, styles: { halign: 'right', fontStyle: 'bold' } }, { content: formatCurrency(grandTotal), styles: { halign: 'right', fontStyle: 'bold' } }]],
          footStyles: { fillColor: [245, 245, 244], textColor: [28, 25, 23] },
          columnStyles: { 0: { halign: 'left',  cellWidth: 'auto' }, 1: { halign: 'right', cellWidth: 25 }, 2: { halign: 'right', cellWidth: 25 }, 3: { halign: 'right', cellWidth: 30 } },
          didParseCell(data) { if (data.section === 'head') { data.cell.styles.halign = data.column.index === 0 ? 'left' : 'right'; } },
          didDrawCell: function(data) { if (!pdfA11y) return; if (data.section === 'head') return; if (data.section === 'body' && data.column.index === 0) { try { const r = rows[data.row.index] || []; const summary = `Row ${data.row.index + 1}: ${r[0]}; Qty ${r[1]}; Rate ${r[2]}; Total ${r[3]}.`; doc.setTextColor(120,113,108); doc.setFontSize(6); doc.text(summary, data.cell.x + 0.2, data.cell.y + data.cell.height - 0.6); } catch (_) {} } }
        });

        const finalTableY = doc.lastAutoTable.finalY || tableStartY + (doc.lastAutoTable.height || 0);
        let notesY = finalTableY + 10;
        const notesValue = notesInput ? notesInput.value.trim() : '';
        const bottomMargin = 20;
        const pageHeight = doc.internal.pageSize.height;
        const labelGap = 2;

        if (notesValue) {
            const notesLabelText = "Notes / Payment Terms:";
            doc.setFont('helvetica', 'bold'); doc.setFontSize(10); doc.setTextColor.apply(null, stone_700);
            const notesLabelWidth = doc.getTextWidth(notesLabelText);
            const notesDataX = margin + notesLabelWidth + labelGap;
            const notesDataWidth = pageWidth - margin - notesDataX;
            
            const notesLines = doc.splitTextToSize(notesValue, notesDataWidth);
            const notesHeight = doc.getTextDimensions(notesLines).h + 5; // +5 for label height approx

            if (notesY + notesHeight > pageHeight - bottomMargin) {
                doc.addPage();
                notesY = margin + 10;
            }
            
            // Draw label
            doc.setFont('helvetica', 'bold'); doc.setFontSize(10); doc.setTextColor.apply(null, stone_700);
            doc.text(notesLabelText, margin, notesY);

            // Draw notes text
            doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
            doc.text(notesLines, notesDataX, notesY);
        }

        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            drawPdfFooter(doc, i, pageCount, margin, pageWidth);
        }

        doc.save(`invoice-${currentInvoiceNumber}.pdf`);

        // --- [MODIFIED BLOCK] ---
        // Removed all calls to clearInvoice()
        if (invoiceNumberInput) {
          const currentInvoiceStr = invoiceNumberInput.value; const match = currentInvoiceStr.match(/(\d+)$/);
          if (match) {
              const numberPart = match[1];
              const prefix = currentInvoiceStr.slice(0, -numberPart.length);
              const newNumberPart = String(parseInt(numberPart, 10) + 1).padStart(numberPart.length, '0');
              invoiceNumberInput.value = prefix + newNumberPart;
              saveInvoiceData(); // Save the new invoice number
            } else {
              saveInvoiceData(); // Save whatever is there
            }
        } else {
            saveInvoiceData(); // Save whatever is there
        }
        
        // Re-render to restore the active editor row, which was
        // committed (and thus removed) by commitActiveEditor()
        renderInvoice();
        // --- [END MODIFIED BLOCK] ---
      }

      function clearInvoice(resetNumber = true) {
        invoiceData = [ defaultFirstRow() ];

        logoPart1.value = localStorage.getItem('logoPart1') || 'AI';
        logoPart2.value = localStorage.getItem('logoPart2') || 'IT.';
        autoResizeInput(logoPart1);
        autoResizeInput(logoPart2);

        const [from1, fromRestVal] = splitAddress(localStorage.getItem('lastFrom') || 'Your Company, Inc.');
        fromLine1.value = from1;
        fromRest.value = fromRestVal;

        const [client1, clientRestVal] = splitAddress(localStorage.getItem('lastClient') || 'Customer Name');
        clientLine1.value = client1;
        clientRest.value = clientRestVal;

        setNotes(localStorage.getItem('lastNotes') || '');
        dateIssuedInput.value = getTodayDateString();
        if (resetNumber && invoiceNumberInput) {
          invoiceNumberInput.value = localStorage.getItem('lastInvoiceNumber') || '001';
        }
        if (isPreviewMode) {
          isPreviewMode = false;
          previewInvoiceBtn.classList.remove('active');
          previewInvoiceBtn.setAttribute('aria-pressed', 'false');
          eyeIcon.classList.remove('hidden');
          eyeSlashIcon.classList.add('hidden');
        }
        activeEditIndex = 0; // --- [NEW] Reset active editor to row 0
        renderInvoice();
      }

      if (exportPdfBtn) exportPdfBtn.addEventListener('click', exportToPdf);
      if (newInvoiceBtn) newInvoiceBtn.addEventListener('click', () => clearInvoice(true));

      if (previewInvoiceBtn) {
          previewInvoiceBtn.addEventListener('click', () => {
              isPreviewMode = !isPreviewMode; // Toggle the state
              previewInvoiceBtn.setAttribute('aria-pressed', String(isPreviewMode));

              if (isPreviewMode) {
                  previewInvoiceBtn.classList.add('active');
                  eyeIcon.classList.add('hidden');
                  eyeSlashIcon.classList.remove('hidden');
              } else {
                  previewInvoiceBtn.classList.remove('active');
                  eyeIcon.classList.remove('hidden');
                  eyeSlashIcon.classList.add('hidden');
              }
              
              // --- [NEW] Commit and re-render ---
              commitActiveEditor();
              renderInvoice(); 
          });
      }

      initializeDashboard();

    });
  </script>

</body>
</html>
