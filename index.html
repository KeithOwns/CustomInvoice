<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - AIIT.support</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root { --font-inter: 'Inter', sans-serif; }
    body { font-family: var(--font-inter); }
    .break-words { word-break: break-word; }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    .safe-bottom { padding-bottom: max(0.5rem, env(safe-area-inset-bottom)); }
    .safe-top { padding-top: max(0.5rem, env(safe-area-inset-top)); }
    textarea { resize: vertical; }
    #previewInvoiceBtn.active { background-color: #d1fae5; color: #047857; }
    
    /* Hide the default calendar icon */
    input[type="date"]::-webkit-calendar-picker-indicator {
      display: none;
      -webkit-appearance: none;
    }

    /* --- [MODIFIED] Step 2: Make inputs invisible --- */
    .invisible-input, .invisible-input:focus {
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      appearance: none !important;
      background-color: transparent !important;
      resize: none !important;
      padding-left: 0 !important;
      padding-right: 0 !important;
    }
    /* Special handling for the invoice number's hash */
    #invoiceNumber.invisible-input {
      padding-left: 1.5rem !important; /* (Increased from 1.25rem) Keep padding for the '#' */
    }
    /* [REMOVED] Special handling for the date input's icon was here */
    /* [REMOVED] .address-label rule was here */
    /* --- [END MODIFIED] --- */

    /* [REMOVED] Gemini Styles were here */

  </style>
</head>
<body class="bg-stone-100 p-4 sm:p-6 lg:p-8 safe-top safe-bottom">

  <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden">

    <div class="border-b border-stone-200">

      <div class="flex justify-end p-4 gap-3">
        <button id="newInvoiceBtn" type="button" class="bg-white hover:bg-stone-100 text-stone-700 w-10 h-10 rounded-full transition-colors flex items-center justify-center shadow-lg border border-stone-200" aria-label="New Invoice" title="New Invoice">
          <!-- [MODIFIED] Changed plus color to teal -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-teal-600"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v4h4a1 1 0 110 2h-4v4a1 1 0 11-2 0v-4H5a1 1 0 110-2h4V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>
        </button>
        <button id="previewInvoiceBtn" type="button" class="bg-white hover:bg-stone-100 text-stone-700 w-10 h-10 rounded-full transition-colors flex items-center justify-center shadow-lg border border-stone-200" aria-label="Toggle Preview" title="Show Values" aria-pressed="false">
          <svg id="preview-icon-eye" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 hidden">
            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
          </svg>
          <!-- [MODIFIED] Changed icon to '***' text -->
          <span id="preview-icon-masked" class="font-bold text-teal-600 tracking-tighter">***</span>
        </button>
        <button id="exportPdfBtn" type="button" class="bg-teal-600 hover:bg-teal-700 text-white w-10 h-10 rounded-full transition-colors flex items-center justify-center shadow-lg border border-stone-200" aria-label="Export as PDF" title="Export as PDF">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
        </button>
      </div>

      <div class="flex items-start justify-between px-6 pb-6">
        <div class="flex-1 pt-2">
          <a href="https://www.aiit.support" target="_blank" rel="noopener noreferrer">
            <span class="text-2xl font-bold text-stone-800">
              <span class="text-teal-600">AI</span>IT.
            </span>
          </a>
        </div>
        
        <div class="flex-1 flex justify-end">
          <div class="grid grid-cols-[auto,1fr] items-center gap-y-1 gap-x-0">
            
            <label for="invoiceNumber" class="text-sm font-bold uppercase text-stone-700 text-right">INVOICE:</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 flex items-center pl-2 text-stone-500">#</span>
              <input id="invoiceNumber" type="text" maxlength="8" class="invisible-input font-bold w-28 rounded-md border-stone-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 py-0.5 pr-3 pl-5" />
            </div>
            
            <label for="dateIssued" class="text-sm font-bold uppercase text-stone-700 text-right whitespace-nowrap">DATE ISSUED:</label>
            <div class="relative">
              <input id="dateIssued" type="date" class="invisible-input font-bold uppercase w-full rounded-md border-stone-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 py-0.5 pl-2 pr-3 cursor-pointer" />
            </div>

          </div>
        </div>
        </div>
      
      <div class="p-6 border-t border-stone-200">
        <div class="grid grid-cols-2 gap-6">
          
          <div class="min-w-[12rem] self-start grid grid-cols-[auto,1fr] items-start gap-x-2 gap-y-1">
            <label for="from-line1" class="block text-sm font-bold text-teal-600 whitespace-nowrap pt-1 text-right">FROM:</label>
            <input id="from-line1" type="text" class="invisible-input font-bold block w-full rounded-md py-1 px-3" />
            
            <label for="from-rest" class="block">&nbsp;</label> <textarea id="from-rest" rows="2" class="invisible-input block w-full rounded-md py-1 px-3"></textarea>
          </div>
          
          <div class="min-w-[12rem] self-start grid grid-cols-[auto,1fr] items-start gap-x-2 gap-y-1">
            <label for="client-line1" class="block text-sm font-bold text-teal-600 whitespace-nowrap pt-1 text-right">BILL TO:</label>
            <input id="client-line1" type="text" required class="invisible-input font-bold block w-full rounded-md py-1 px-3" />
            
            <label for="client-rest" class="block">&nbsp;</label> <textarea id="client-rest" rows="2" required class="invisible-input block w-full rounded-md py-1 px-3"></textarea>
          </div>

        </div>
      </div>
    </div>
    
    <main class="p-6">
      <section class="overflow-x-auto border border-stone-200 rounded-lg">
        <table id="invoiceTable" class="min-w-full table-fixed divide-y divide-stone-200">
          <colgroup>
            <col>
            <col class="w-[8ch]">
            <col class="w-[7ch]">
            <col class="w-[9ch]">
            <col class="w-[44px]">
          </colgroup>
          <thead class="bg-teal-600">
             <tr>
              <th scope="col" class="px-4 py-2 text-left    text-xs font-medium text-white uppercase tracking-wider">Description of Work</th>
              <th scope="col" class="px-4 py-2 text-right   text-xs font-medium text-white uppercase tracking-wider whitespace-nowrap">QTY / HRS</th>
              <th scope="col" class="px-2 py-2 text-right   text-xs font-medium text-white uppercase tracking-wider">RATE</th>
              <th scope="col" class="px-2 py-2 text-right   text-xs font-medium text-white uppercase tracking-wider">TOTAL</th>
              <th scope="col" class="px-2 py-2 text-center text-xs font-medium text-white uppercase tracking-wider"></th>
            </tr>
          </thead>
          <tbody class="divide-y divide-stone-200"></tbody>
          <tfoot class="bg-stone-50">
            <tr class="border-t-2 border-stone-300">
              <td colspan="3" class="px-4 py-2 text-right font-bold text-stone-900">Total Amount Due:</td>
              <td class="px-2 py-2 whitespace-nowrap font-bold text-stone-900 text-right text-lg">
                <span id="grandTotalCell"></span>
              </td>
              <td></td> </tr>
          </tfoot>
        </table>
      </section>
    </main>
    
    <footer class="bg-stone-50 p-6 border-t border-stone-200">
        <!-- [MODIFIED] Reverted grid cols and removed AI button -->
        <section class="grid grid-cols-[auto,1fr] items-start gap-x-2">
          <label for="notes" class="block text-sm font-bold text-stone-700 whitespace-nowrap pt-2 text-right">Notes / Payment Terms:</label>
          <textarea id="notes" rows="1" class="invisible-input block w-full h-auto overflow-auto whitespace-pre-wrap rounded-md border-stone-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 px-3 py-2"></textarea>
        </section>
    </footer>

    <!-- [REMOVED] Context Menu was here -->

  </div>
  
  <!-- [REMOVED] Gemini Modal was here -->

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // [REMOVED] GEMINI_API_KEY was here

      // [MODIFIED] Updated element IDs
      const clientLine1 = document.getElementById('client-line1');
      const clientRest = document.getElementById('client-rest');
      const fromLine1 = document.getElementById('from-line1');
      const fromRest = document.getElementById('from-rest');
      
      const invoiceTableBody = document.querySelector('#invoiceTable tbody');
      const grandTotalCell = document.getElementById('grandTotalCell');
      const invoiceNumberInput = document.getElementById('invoiceNumber');
      const dateIssuedInput = document.getElementById('dateIssued');
      const notesInput = document.getElementById('notes');
      const exportPdfBtn = document.getElementById('exportPdfBtn');
      const newInvoiceBtn = document.getElementById('newInvoiceBtn');
      const previewInvoiceBtn = document.getElementById('previewInvoiceBtn');
      const eyeIcon = document.getElementById('preview-icon-eye');
      const maskedIcon = document.getElementById('preview-icon-masked'); // [MODIFIED]
      // [REMOVED] contextMenu was here

      // [REMOVED] Gemini Modal Elements were here

      (function runSelfTests(){
        console.assert(!!invoiceTableBody, 'invoiceTableBody missing');
        // [MODIFIED] Updated assertion
        console.assert(!!fromLine1 && !!fromRest && !!clientLine1 && !!clientRest, 'address fields missing');
        console.assert(!!invoiceNumberInput, 'invoiceNumberInput missing');
        console.assert(!!dateIssuedInput, 'dateIssuedInput missing');
        console.assert(!!exportPdfBtn && !!newInvoiceBtn, 'header buttons missing');
        console.assert(!!previewInvoiceBtn, 'preview button missing');
        // [REMOVED] contextMenu assertion was here
        // [REMOVED] Gemini Assertions were here
      })();

      let invoiceData = [];
      let isPreviewMode = false; // Default to 'false' (masked)
      let activeEditIndex = 0; 
      // [REMOVED] contextMenuRowIndex was here

      // [REMOVED] callGeminiApi function was here

      // [REMOVED] handleSparkleDesc function was here
      
      // [REMOVED] handleSparkleNotes function was here

      Object.defineProperty(window, 'invoiceData', {
        configurable: true,
        get: () => invoiceData,
        set: v => { invoiceData = Array.isArray(v) ? v : []; renderInvoice(); }
      });

      function formatCurrency(amount) {
        const num = Number.isFinite(Number(amount)) ? Number(amount) : 0;
        return num.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function getTodayDateString() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      function autoResizeTextarea(el) {
        if (!el) return;
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
      }

      // --- [NEW] Function to split address for new inputs ---
      function splitAddress(fullAddress) {
        const lines = (fullAddress || '').split('\n');
        const firstLine = lines.shift() || '';
        const rest = lines.join('\n');
        return [firstLine, rest];
      }

      // --- [NEW] Function to sync address textareas ---
      function syncTextareaHeights() {
          if (!fromRest || !clientRest) return;
          // Temporarily reset heights to get natural scrollHeight
          fromRest.style.height = 'auto';
          clientRest.style.height = 'auto';
          
          const fromHeight = fromRest.scrollHeight;
          const clientHeight = clientRest.scrollHeight;
          
          const maxHeight = Math.max(fromHeight, clientHeight, 28); // 28px min height
          
          fromRest.style.height = maxHeight + 'px';
          clientRest.style.height = maxHeight + 'px';
      }

      function defaultFirstRow() { return { description: 'Products & Services', quantity: 6.0, unit: 'Hrs', rate: 75.00, total: 6.0 * 75.00 }; }
      // [NEW] Blank entry function
      function blankEntry() { return { description: '', quantity: '', unit: 'Hrs', rate: '', total: 0 }; }

      const DEFAULT_NOTES = 'Thank you for your business!';
      function migrateNotes(val) {
        const s = String(val || '').trim();
        const lower = s.toLowerCase();
        if (!s) return DEFAULT_NOTES;
        if (lower === 'payment is due within 15 days.' || lower === 'payment is due within 15 days') return DEFAULT_NOTES;
        return s;
      }
      function setNotes(value) {
        const n = document.getElementById('notes');
        if (n) n.value = migrateNotes(value);
      }

      const TIMEOUT_MS = 4000;
      function withTimeout(promise, ms = TIMEOUT_MS) {
        return Promise.race([
          promise,
          new Promise((_, rej) => setTimeout(() => rej(new Error('Request timeout')), ms))
        ]);
      }
      async function fetchJson(url, options) {
        try {
          const res = await withTimeout(fetch(url, options));
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const ct = res.headers.get('content-type') || '';
          if (!ct.includes('application/json')) throw new Error('Invalid content-type');
          return await res.json();
        } catch (e) { console.warn('fetchJson failed:', e?.message || e); return null; }
      }
      async function postJson(url, body) {
        try { await withTimeout(fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })); }
        catch (e) { console.warn('postJson failed:', e?.message || e); }
      }

      const api = { getInvoice: () => fetchJson('/api/invoices'), saveInvoice: (payload) => postJson('/api/invoices', payload) };

      // [MODIFIED] To handle new address fields
      function setGlobalDefaults() {
        if (invoiceNumberInput) invoiceNumberInput.value = localStorage.getItem('lastInvoiceNumber') || '001';
        
        const [from1, fromRestVal] = splitAddress(localStorage.getItem('lastFrom') || 'Your Company, Inc.');
        fromLine1.value = from1;
        fromRest.value = fromRestVal;
        
        const [client1, clientRestVal] = splitAddress(localStorage.getItem('lastClient') || 'Customer Name');
        clientLine1.value = client1;
        clientRest.value = clientRestVal;

        setNotes(localStorage.getItem('lastNotes') || '');
        dateIssuedInput.value = getTodayDateString();
      }

      // [MODIFIED] To handle new address fields
      function ensureDefaults() {
        if (invoiceNumberInput && !invoiceNumberInput.value) invoiceNumberInput.value = localStorage.getItem('lastInvoiceNumber') || '001';
        
        if (!fromLine1.value && !fromRest.value) {
            const [from1, fromRestVal] = splitAddress(localStorage.getItem('lastFrom') || 'Your Company, Inc.');
            fromLine1.value = from1;
            fromRest.value = fromRestVal;
        }
        if (!clientLine1.value && !clientRest.value) {
            const [client1, clientRestVal] = splitAddress(localStorage.getItem('lastClient') || 'Customer Name');
            clientLine1.value = client1;
            clientRest.value = clientRestVal;
        }

        const n = document.getElementById('notes');
        if (n && !n.value)          setNotes(localStorage.getItem('lastNotes') || '');
        if (!dateIssuedInput.value)     dateIssuedInput.value   = getTodayDateString();
        if (!invoiceData || invoiceData.length === 0) invoiceData = [ defaultFirstRow() ];
      }

      // [MODIFIED] To handle new address fields
      async function initializeDashboard() {
        try {
          const savedInvoice = await api.getInvoice();
          if (savedInvoice && typeof savedInvoice === 'object' && (savedInvoice.invoiceNumber || (Array.isArray(savedInvoice.items) && savedInvoice.items.length))) {
            if (invoiceNumberInput) invoiceNumberInput.value = savedInvoice.invoiceNumber || '';
            
            const [from1, fromRestVal] = splitAddress(savedInvoice.contractorName);
            fromLine1.value = from1;
            fromRest.value = fromRestVal;
            
            const [client1, clientRestVal] = splitAddress(savedInvoice.client);
            clientLine1.value = client1;
            clientRest.value = clientRestVal;

            setNotes(savedInvoice.notes || '');
            invoiceData = Array.isArray(savedInvoice.items) ? savedInvoice.items : [];
          } else {
            setGlobalDefaults();
            try { invoiceData = JSON.parse(localStorage.getItem('lastInvoiceData') || '[]'); } catch { invoiceData = []; }
          }
        } catch (error) {
          console.error('initializeDashboard hard failure:', error);
          setGlobalDefaults();
          try { invoiceData = JSON.parse(localStorage.getItem('lastInvoiceData') || '[]'); } catch { invoiceData = []; }
        } finally {
          try { 
            ensureDefaults(); 
            activeEditIndex = 0; // Ensure editor starts at row 0
            renderInvoice(); 
            saveInvoiceData(); 
            syncTextareaHeights(); // Sync heights on load
          }
          catch (e) { console.error('Finalization error:', e); }
        }
      }

      let saveDebounceId; function saveInvoiceData() { if (saveDebounceId) clearTimeout(saveDebounceId); saveDebounceId = setTimeout(_saveInvoiceData, 250); }
      
      // [MODIFIED] To handle new address fields
      function _saveInvoiceData() {
        const n = document.getElementById('notes');
        const canonicalNotes = migrateNotes(n ? n.value : '');
        if (n) n.value = canonicalNotes;
        
        const contractorName = (fromLine1.value + '\n' + fromRest.value).trim();
        const clientName = (clientLine1.value + '\n' + clientRest.value).trim();
        
        try {
          if (invoiceNumberInput) localStorage.setItem('lastInvoiceNumber', invoiceNumberInput.value);
          localStorage.setItem('lastFrom', contractorName);
          localStorage.setItem('lastClient', clientName);
          localStorage.setItem('lastNotes', canonicalNotes);
          localStorage.setItem('lastInvoiceData', JSON.stringify(invoiceData));
        } catch (e) { console.warn('localStorage save failed', e); }
        
        const payload = { 
            invoiceNumber: invoiceNumberInput ? invoiceNumberInput.value : '', 
            contractorName: contractorName, 
            client: clientName, 
            notes: canonicalNotes, 
            items: invoiceData 
        };
        api.saveInvoice(payload);
      }

      function updateGrandTotal() {
        const grandTotal = invoiceData.reduce((s, it) => s + (Number(it.total) || 0), 0);
        const formatted = formatCurrency(grandTotal);
        // Show formatted currency when preview is ON (true), hide it ('***') when preview is OFF (false)
        // [MODIFIED] Added teal color class
        grandTotalCell.textContent = isPreviewMode ? formatted : '***';
        if (!isPreviewMode) {
            grandTotalCell.classList.add('text-teal-600');
        } else {
            grandTotalCell.classList.remove('text-teal-600');
        }
        grandTotalCell.setAttribute('data-actual', formatted);
      }

      function cloneEntry(e) { return { description: e.description, quantity: e.quantity, unit: e.unit, rate: e.rate, total: e.total }; }
      function parseTimeToDecimal(t) { if (!t) return 0; if (!String(t).includes(':')) { const n = parseFloat(t); return Number.isFinite(n) ? n : 0; } const [h,m]=String(t).split(':'); return (parseInt(h,10)||0)+((parseInt(m,10)||0)/60); }
      function tdText(cls, text) { const td=document.createElement('td'); td.className=cls; td.textContent=text; return td; }
      
      // [MODIFIED] Validation logic
      function parseQtyInput(val, unit) {
        if (val === '') return 1.0; // Default to 1.0 if blank
        const parsedVal = unit === 'Hrs' ? parseTimeToDecimal(val) : parseFloat(val);
        // Disallow negative QTY or 0
        if (!Number.isFinite(parsedVal) || parsedVal <= 0) return 0; 
        return parsedVal;
      }
      
      // --- [MODIFIED] Uses generic 'edit-rate' ID ---
      function commitRateFromInput() {
        const rateEl = document.getElementById('edit-rate'); // Use generic ID
        if (!rateEl) return;

        // If the element is active, its value is raw. Commit it to dataset.
        if (document.activeElement === rateEl) {
             const raw = (rateEl.value || '').replace(/[^0-9.]/g, '');
             let numeric = parseFloat(raw);
             // [MODIFIED] Enforce positive rate
             if (!Number.isFinite(numeric) || numeric < 0) numeric = 0;
             rateEl.dataset.actual = numeric.toFixed(2);
        } else {
            // If element is not active, its value is already a display value ('**' or '$').
            // We must check if that display value has been manually changed (e.g., user typed and clicked away)
            const maskedDisplay = '***'; // [MODIFIED]
            const currencyDisplay = formatCurrency(parseFloat(rateEl.dataset.actual || '0') || 0);
            const displayValue = isPreviewMode ? currencyDisplay : maskedDisplay;
            
            if (rateEl.value !== displayValue) {
                // User typed something and blurred.
                const raw = (rateEl.value || '').replace(/[^0-9.]/g, '');
                let numeric = parseFloat(raw);
                // [MODIFIED] Enforce positive rate
                if (!Number.isFinite(numeric) || numeric < 0) numeric = 0;
                rateEl.dataset.actual = numeric.toFixed(2);
            }
        }
        
        // Finally, set the display value
        // [MODIFIED] Use '***' for masked display
        rateEl.value = isPreviewMode ? formatCurrency(parseFloat(rateEl.dataset.actual || '0') || 0) : '***';
      }

      // --- [NEW] Saves data from active editor to invoiceData array ---
      function commitActiveEditor() {
          if (activeEditIndex === null || !invoiceData[activeEditIndex] || !document.getElementById('edit-desc')) {
             // Editor isn't rendered or valid, so nothing to commit.
             return; 
          }

          const entry = invoiceData[activeEditIndex];
          const descEl = document.getElementById('edit-desc');
          const qtyEl  = document.getElementById('edit-qty');
          const rateEl = document.getElementById('edit-rate');
          const totalInputEl = document.getElementById('edit-total-input');
          
          entry.description = descEl.value;
          entry.quantity = qtyEl.value; // Save raw string
          
          commitRateFromInput(); // This will fix the input's value AND update dataset.actual
          entry.rate = parseFloat(rateEl.dataset.actual || '0') || 0;
          
          // --- [NEW] Check if total is manual ---
          const isManualTotal = (String(entry.quantity).trim() === '') && (Number(entry.rate) || 0) === 0;
          
          if (isManualTotal && totalInputEl) {
              // If manual, read from the total input's dataset
              entry.total = parseFloat(totalInputEl.dataset.actual || '0') || 0;
          } else {
              // If calculated, re-calculate
              const qtyForCalc = parseQtyInput(entry.quantity, entry.unit);
              entry.total = qtyForCalc * entry.rate;
          }
          
          saveInvoiceData();
      }

      // --- [NEW] Handles live typing in the active editor ---
      function recalcAndPersistActiveRow() {
          // This function is for live updates *while typing*
          if (activeEditIndex === null || !invoiceData[activeEditIndex]) return;

          const row = invoiceData[activeEditIndex];
          const descEl = document.getElementById('edit-desc');
          const qtyEl  = document.getElementById('edit-qty');
          const rateEl = document.getElementById('edit-rate');
          const totalEl = document.getElementById('edit-total'); // Span
          const totalInputEl = document.getElementById('edit-total-input'); // Input

          if (!descEl || !qtyEl || !rateEl || !totalEl || !totalInputEl) return;

          row.description = descEl.value;
          
          const activeEl = document.activeElement;
          
          // --- [MODIFIED] Logic for QTY/RATE/TOTAL ---
          if (activeEl.id === 'edit-total-input') {
              // User is typing in TOTAL. This is a manual override.
              // [MODIFIED] Allow negative sign
              const raw = (totalInputEl.value || '').replace(/[^0-9.-]/g, '');
              let n = parseFloat(raw);
              // [MODIFIED] Allow negative numbers
              if (!Number.isFinite(n)) n = 0;

              row.total = n;
              totalInputEl.dataset.actual = n.toFixed(2);
              
              // When user types in TOTAL, we must be in manual mode, so QTY/RATE are blank.
              row.quantity = ''; // Store raw string
              row.rate = '';     // Store raw string

          } else {
              // User is typing in DESC, QTY, or RATE.
              row.quantity = qtyEl.value; // Store the raw string
              
              const qtyForCalc = parseQtyInput(qtyEl.value, row.unit); // Get calc value (1.0 for blank)

              if (activeEl.id === 'edit-rate') {
                  const raw = (rateEl.value || '').replace(/[^0-9.]/g, '');
                  let n = parseFloat(raw);
                  if (!Number.isFinite(n) || n < 0) n = 0; 
                  row.rate = n;
                  rateEl.dataset.actual = row.rate.toFixed(2);
              } else {
                  row.rate = parseFloat(rateEl.dataset.actual || '0') || 0;
              }
              
              // Store rate as a string for 'blank' check
              if (row.rate > 0) {
                 row.rate = String(row.rate);
              } else if (activeEl.id !== 'edit-rate') {
                 // Don't overwrite if user is clearing rate
                 if (rateEl.value !== '') {
                    row.rate = String(row.rate);
                 } else {
                    row.rate = '';
                 }
              } else {
                row.rate = '';
              }
              
              row.total = qtyForCalc * (Number(row.rate) || 0);
          }

          // --- [NEW] Visibility Logic ---
          // Check the state *after* updates.
          // Use raw `row.quantity` and `row.rate`.
          const isNowManual = (String(row.quantity).trim() === '') && (Number(row.rate) || 0) === 0;

          if (isNowManual) {
              // Show INPUT
              if (activeEl.id !== 'edit-total-input') {
                  // Update input's value if it's not active
                  totalInputEl.dataset.actual = row.total.toFixed(2);
                  totalInputEl.value = isPreviewMode ? formatCurrency(row.total) : '***';
              }
              if (!isPreviewMode) totalInputEl.classList.add('text-teal-600');
              else totalInputEl.classList.remove('text-teal-600');
              
              totalEl.classList.add('hidden');
              totalInputEl.classList.remove('hidden');
          } else {
              // Show SPAN
              totalEl.textContent = isPreviewMode ? formatCurrency(row.total) : '***';
              if (!isPreviewMode) {
                  totalEl.classList.add('text-teal-600');
              } else {
                  totalEl.classList.remove('text-teal-600');
              }
              totalEl.classList.remove('hidden');
              totalInputEl.classList.add('hidden');
          }
          
          updateGrandTotal();
          saveInvoiceData();
      }
      
      // [NEW] Handles "Enter" key press in the editor
      function handleEditorKeydown(event) {
          // Only trigger on "Enter" (without Shift) and only on the top row
          if (event.key !== 'Enter' || event.shiftKey || activeEditIndex !== 0) {
              return;
          }
          
          event.preventDefault(); // Stop default "Enter" action (newline or form submit)
          
          commitActiveEditor(); // Save the current state of row 0
          
          const entryToDuplicate = cloneEntry(invoiceData[0]);
          
          // --- Validation ---
          // 1. Check Description
          if (entryToDuplicate.description.trim() === '') {
              flashValidationError('edit-desc');
              return;
          }
          
          // 2. Check QTY/RATE/TOTAL
          const isManualTotal = (String(entryToDuplicate.quantity).trim() === '') && (Number(entryToDuplicate.rate) || 0) === 0;
          const qtyForCalc = parseQtyInput(entryToDuplicate.quantity, entryToDuplicate.unit);
          
          if (isManualTotal) {
               // [MODIFIED] Validation for manual total removed to allow negative values.
               // User is overriding, so any value (including 0 or negative) is allowed.
          } else {
              // In calculated mode, QTY and RATE must be positive
              if (qtyForCalc <= 0) {
                  flashValidationError('edit-qty');
                  return;
              }
              if (entryToDuplicate.rate <= 0) {
                  flashValidationError('edit-rate');
                  return;
              }
          }
          // --- End Validation ---
          
          // Create the new blank row for the top
          const newTopRow = blankEntry();
          newTopRow.unit = entryToDuplicate.unit; // Inherit unit
          newTopRow.quantity = entryToDuplicate.quantity; // Inherit quantity
          newTopRow.rate = entryToDuplicate.rate; // Inherit rate
          
          invoiceData[0] = newTopRow; // Set row 0 to the new blank-ish row
          invoiceData.splice(1, 0, entryToDuplicate); // Insert the saved data at row 1
          
          activeEditIndex = 0; // Keep editor on the new top row
          
          renderInvoice(); 
          saveInvoiceData(); // Save the updated array

          // Focus the new description input
          const firstDesc = document.getElementById('edit-desc');
          if (firstDesc) {
              requestAnimationFrame(() => firstDesc.focus());
          }
      }

      // [NEW] Helper function to flash a validation error
      function flashValidationError(elementId) {
          const el = document.getElementById(elementId);
          if (!el) return;
          el.classList.add('ring-2', 'ring-red-500');
          setTimeout(() => el.classList.remove('ring-2', 'ring-red-500'), 700);
      }

      // --- [HEAVILY MODIFIED] ---
      function renderInvoice() {
        invoiceTableBody.innerHTML = '';
        
        invoiceData.forEach((entry, index) => {
          const newRow = document.createElement('tr');
          newRow.className = (index % 2 !== 0) ? 'bg-stone-50' : 'bg-white';

          // Use parseQtyInput to handle '1.0' default for blank
          const qtyForCalc = parseQtyInput(String(entry.quantity), entry.unit);
          const actualRate = (Number(entry.rate) || 0);
          
          // [MODIFIED] Check if total is manual
          const isManualTotalStatic = (String(entry.quantity).trim() === '') && (Number(entry.rate) || 0) === 0;
          let actualTotal;
          
          if (isManualTotalStatic) {
              actualTotal = (Number(entry.total) || 0); // Use stored total
          } else {
              actualTotal = qtyForCalc * actualRate; // Recalculate
              entry.total = actualTotal; // Persist this calculation
          }

          const qtyDisplay = entry.unit === 'Hrs' ? qtyForCalc.toFixed(2) : String(parseInt(qtyForCalc, 10));

          // --- Polarity is: Preview ON (true) = Show Currency, Preview OFF (false) = Show '***' ---
          // [MODIFIED] Use '***'
          const rateDisplay = isPreviewMode ? formatCurrency(actualRate) : '***';
          const totalDisplay = isPreviewMode ? formatCurrency(actualTotal) : '***';
          const maskedColorClass = !isPreviewMode ? 'text-teal-600' : '';

          if (index === activeEditIndex) {
            // --- This row IS the active editor ---
            // [MODIFIED] Added shadow-inner-lg
            newRow.className += ' shadow-inner-lg';

            const tdDesc = document.createElement('td');
            // [MODIFIED] Reverted className
            tdDesc.className = 'px-4 py-2';
            const descArea = document.createElement('textarea');
            descArea.id = 'edit-desc'; // Generic ID
            // [MODIFIED] Added invisible-input class
            descArea.className = 'invisible-input w-full rounded-md border-stone-300 border shadow-sm focus:border-teal-500 focus:ring-teal-500 px-2 py-1 resize-none';
            descArea.rows = 2; descArea.value = entry.description || '';
            
            // [REMOVED] Sparkle button was here
            
            // [MODIFIED] Reverted append
            tdDesc.appendChild(descArea);

            const tdQty = document.createElement('td'); tdQty.className = 'px-4 py-2 whitespace-nowrap text-right';
            const qtyInput = document.createElement('input');
            qtyInput.id = 'edit-qty'; // Generic ID
            qtyInput.setAttribute('inputmode','decimal');
            // [MODIFIED] Added invisible-input class
            qtyInput.className = 'invisible-input w-12 text-right rounded-md border-stone-300 border shadow-sm focus:border-teal-500 focus:ring-teal-500 px-2 py-1';
            // [MODIFIED] Use entry.quantity (raw value) not qtyDisplay
            qtyInput.value = entry.quantity; 
            tdQty.appendChild(qtyInput);

            const tdRate = document.createElement('td'); tdRate.className = 'px-2 py-2 whitespace-nowrap text-right';
            const rateInput = document.createElement('input');
            rateInput.id = 'edit-rate'; // Generic ID
            rateInput.type = 'text'; rateInput.inputMode = 'decimal';
            // [MODIFIED] Added invisible-input class and masked color
            rateInput.className = `invisible-input w-16 text-right rounded-md border-stone-300 border shadow-sm focus:border-teal-500 focus:ring-teal-500 px-2 py-1 ${maskedColorClass}`;
            rateInput.dataset.actual = actualRate.toFixed(2);
            rateInput.value = rateDisplay; // Set display value
            tdRate.appendChild(rateInput);

            const tdTotal = document.createElement('td'); tdTotal.className = 'px-2 py-2 whitespace-nowrap text-right';

            // --- [NEW] Create both span and input for TOTAL ---
            const totalSpan = document.createElement('span');
            totalSpan.id = 'edit-total';
            totalSpan.className = maskedColorClass;
            
            const totalInput = document.createElement('input');
            totalInput.id = 'edit-total-input';
            totalInput.type = 'text';
            totalInput.inputMode = 'decimal';
            // [MODIFIED] Increased width w-20
            totalInput.className = `invisible-input w-20 text-right rounded-md border-stone-300 border shadow-sm focus:border-teal-500 focus:ring-teal-500 px-2 py-1 ${maskedColorClass}`;
            
            // Check if total should be manual (blank qty AND blank rate)
            // Use raw entry values
            const isManualTotal = (String(entry.quantity).trim() === '') && (Number(entry.rate) || 0) === 0;

            if (isManualTotal) {
                totalSpan.classList.add('hidden');
                totalInput.dataset.actual = actualTotal.toFixed(2);
                // [MODIFIED] Use totalDisplay which is already '***' or formatted
                totalInput.value = totalDisplay; 
            } else { 
                totalInput.classList.add('hidden');
                totalSpan.textContent = totalDisplay;
            }
            
            tdTotal.appendChild(totalSpan); 
            tdTotal.appendChild(totalInput);

            // --- [MODIFIED] Add/Delete Button Logic ---
            const tdActions = document.createElement('td'); 
            tdActions.className = 'px-2 py-2 whitespace-nowrap text-center';
            
            if (index === 0) {
                // --- Top Row: Add Button ---
                const addBtn = document.createElement('button');
                addBtn.className = 'add-button inline-flex items-center justify-center w-8 h-8 rounded-full bg-teal-600 hover:bg-teal-700 text-white font-extrabold text-lg shadow-lg border border-stone-200';
                addBtn.title = 'Add Row';
                addBtn.textContent = '+';
                tdActions.appendChild(addBtn);
            } else {
                // --- Other Rows: Delete Button ---
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-button inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-600 hover:bg-red-700 text-white shadow-lg border border-stone-200';
                deleteBtn.title = 'Delete Row';
                // Minus Circle Icon
                deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM6.75 9.25a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5z" clip-rule="evenodd" /></svg>';
                tdActions.appendChild(deleteBtn);
            }
            // --- [END MODIFIED] Add/Delete Button Logic ---
            
            newRow.appendChild(tdDesc);
            newRow.appendChild(tdQty);
            newRow.appendChild(tdRate);
            newRow.appendChild(tdTotal);
            newRow.appendChild(tdActions);

            // Attach listeners immediately
            requestAnimationFrame(() => autoResizeTextarea(descArea));
            
            // [NEW] Add keydown listener for "Enter"
            descArea.addEventListener('keydown', handleEditorKeydown);

            rateInput.addEventListener('focus', () => {
                const actual = rateInput.dataset.actual || '0.00';
                rateInput.value = actual;
                rateInput.classList.remove('text-teal-600'); // Remove color on focus
                requestAnimationFrame(() => { try { rateInput.select(); } catch {} });
            });
            rateInput.addEventListener('blur', () => {
                commitRateFromInput(); // This function now uses the generic ID
                recalcAndPersistActiveRow(); // This will re-apply color if needed
            });
            rateInput.addEventListener('input', () => {
                recalcAndPersistActiveRow(); // Recalc on input
            });
            // [NEW] Add keydown listener for "Enter"
            rateInput.addEventListener('keydown', handleEditorKeydown);

            descArea.addEventListener('input', () => { autoResizeTextarea(descArea); recalcAndPersistActiveRow(); });
            qtyInput.addEventListener('input', () => { recalcAndPersistActiveRow(); });
            // [NEW] Add keydown listener for "Enter"
            qtyInput.addEventListener('keydown', handleEditorKeydown);

            // --- [NEW] Listeners for manual total input ---
            totalInput.addEventListener('focus', () => {
                const actual = totalInput.dataset.actual || '0.00';
                totalInput.value = actual;
                totalInput.classList.remove('text-teal-600'); // Remove color on focus
                requestAnimationFrame(() => { try { totalInput.select(); } catch {} });
            });
            totalInput.addEventListener('blur', () => {
                // On blur, commit the value to dataset
                // [MODIFIED] Allow negative sign
                const raw = (totalInput.value || '').replace(/[^0-9.-]/g, '');
                let numeric = parseFloat(raw);
                // [MODIFIED] Allow negative numbers
                if (!Number.isFinite(numeric)) numeric = 0;
                totalInput.dataset.actual = numeric.toFixed(2);
                totalInput.value = isPreviewMode ? formatCurrency(numeric) : '***';
                if (!isPreviewMode) totalInput.classList.add('text-teal-600');
                
                recalcAndPersistActiveRow(); // Recalc/save
            });
            totalInput.addEventListener('input', () => {
                recalcAndPersistActiveRow(); // Recalc/save on input
            });
            // [NEW] Add keydown listener for "Enter"
            totalInput.addEventListener('keydown', handleEditorKeydown);

          } else {
            // --- This row is STATIC ---
            const tdDesc = tdText('px-4 py-2 text-sm text-stone-900 break-words', String(entry.description || ''));
            tdDesc.dataset.index = index;
            tdDesc.dataset.field = 'description';
            
            // [MODIFIED] Use qtyDisplay
            const tdQty = tdText('px-4 py-2 whitespace-nowrap text-sm text-stone-500 text-right', qtyDisplay);
            tdQty.dataset.index = index;
            tdQty.dataset.field = 'quantity';
            
            // [MODIFIED] Added masked color
            const tdRate = tdText(`px-2 py-2 whitespace-nowrap text-sm text-stone-500 text-right ${maskedColorClass}`, rateDisplay);
            tdRate.dataset.index = index;
            tdRate.dataset.field = 'rate';
            
            // [MODIFIED] Added masked color
            const tdTotal = tdText(`px-2 py-2 whitespace-nowrap text-sm text-stone-500 text-right ${maskedColorClass}`, totalDisplay);
            tdTotal.dataset.index = index;
            tdTotal.dataset.field = 'total'; // Not editable, but good for consistency
            
            const tdActions = document.createElement('td');
            tdActions.className = 'px-2 py-2';
            tdActions.dataset.index = index; // Clicking here will also activate the row
            tdActions.dataset.field = 'action';

            newRow.appendChild(tdDesc);
            newRow.appendChild(tdQty);
            newRow.appendChild(tdRate);
            newRow.appendChild(tdTotal);
            newRow.appendChild(tdActions);
          }
          invoiceTableBody.appendChild(newRow);
        });
        
        updateGrandTotal();
        autoResizeTextarea(document.getElementById('notes'));
        // [MODIFIED] Call syncTextareaHeights instead of autoResize
        syncTextareaHeights();
      }

      // --- [DELETED] attachFirstRowEditors() function was here ---

      // --- [HEAVILY MODIFIED] ---
      invoiceTableBody.addEventListener('click', function(event) {
        // [REMOVED] Gemini Sparkle Button Logic was here

        // [MODIFIED] Context Menu Logic
        const addBtn = event.target.closest('.add-button');
        const deleteBtn = event.target.closest('.delete-button'); // [NEW]
        const editableCell = event.target.closest('td[data-index]');
        
        // [REMOVED] Hide context menu on any click

        if (addBtn) {
          // --- [MODIFIED] Logic for ADDING a row ---
          
          commitActiveEditor(); // Save current data

          // --- [MODIFIED] New Logic: Add a row ABOVE, inheriting QTY/Unit/Rate ---
          const newIndex = activeEditIndex;
          
          // Get the current row's data (which was just saved)
          const currentEntry = invoiceData[newIndex];
          
          // Create a new blank entry
          const newEntry = blankEntry();
          
          // Set the new entry's quantity/unit to the current entry's
          if (currentEntry) {
            newEntry.quantity = currentEntry.quantity;
            newEntry.unit = currentEntry.unit;
            newEntry.rate = currentEntry.rate; // <-- [NEW] Inherit rate
          }
          
          invoiceData.splice(newIndex, 0, newEntry); // Insert the new row
          activeEditIndex = newIndex; // Move editor to the new row
          
          renderInvoice(); 
          saveInvoiceData(); // Save the updated array

          const firstDesc = document.getElementById('edit-desc');
          if (firstDesc) {
              requestAnimationFrame(() => firstDesc.focus());
           }
          return;
        }
        
        // --- [NEW] Delete Button Logic ---
        if (deleteBtn) {
            commitActiveEditor(); // Save just in case
            
            const i = activeEditIndex;
            
            if (invoiceData.length > 1) {
                invoiceData.splice(i, 1);
                if (activeEditIndex >= i) {
                    activeEditIndex = Math.max(0, activeEditIndex - 1);
                }
            }
            
            renderInvoice();
            saveInvoiceData();
            return; // Stop further click processing
        }
        
        if (editableCell) {
            const index = parseInt(editableCell.dataset.index, 10);
            if (index === activeEditIndex) return; // Already editing this row

            // --- Logic for SWITCHING editor row ---
            commitActiveEditor(); // Save data from the previously active row

            activeEditIndex = index; // Set the new active row
            renderInvoice(); // Re-render the table

            // Find the newly created input and focus it
            const field = editableCell.dataset.field;
            let inputToFocus;
            if (field === 'description') {
                inputToFocus = document.getElementById('edit-desc');
            } else if (field === 'quantity') {
                inputToFocus = document.getElementById('edit-qty');
            } else if (field === 'rate') {
                inputToFocus = document.getElementById('edit-rate');
            }
            
            if (inputToFocus) {
                 requestAnimationFrame(() => {
                    inputToFocus.focus();
                    if (inputToFocus.select) inputToFocus.select();
                 });
            }
        }
      });
      // --- [END MODIFIED EVENT LISTENER] ---

      // [REMOVED] Context Menu Listeners
      // ...
      // ...
      // ...
      // [END REMOVED]


      function getPdfA11yEnabled(){ const v = localStorage.getItem('pdfA11yEnabled'); return v === null ? false : v === 'true'; }
      function setPdfA11yEnabled(val){ try { localStorage.setItem('pdfA11yEnabled', String(!!val)); } catch {} }

      function drawPdfHeader(doc, currentY, margin, pageWidth, teal_600, stone_700, currentInvoiceNumber, dateIssuedDisp, headerLogoData, pdfA11y) {
          const accessible = !!pdfA11y;
          doc.setPage(1); doc.setLanguage('en-US');
          if (accessible) { doc.setFont('helvetica'); doc.setFontSize(0); doc.text(' ', 0, 0); }

          const brandText = 'AIIT.'; const brandTextWidth = doc.getTextWidth(brandText);
          const brandSlogan = 'www.aiit.support'; const brandSloganWidth = doc.getTextWidth(brandSlogan);
          const brandX = margin;
          
          doc.setFont('helvetica', 'bold'); doc.setFontSize(22);
          doc.setTextColor.apply(null, teal_600); doc.text('AI', brandX, currentY);
          doc.setTextColor.apply(null, stone_700); doc.text('IT.', brandX + doc.getTextWidth('AI'), currentY);
          
          doc.setFont('helvetica', 'normal'); doc.setFontSize(9);
          doc.setTextColor.apply(null, [168, 162, 158]);
          doc.text(brandSlogan, brandX, currentY + 4);

          const invoiceLabel = 'INVOICE'; const invoiceLabelWidth = doc.getTextWidth(invoiceLabel);
          const invoiceNum = '#' + currentInvoiceNumber; const invoiceNumWidth = doc.getTextWidth(invoiceNum);
          const dateLabel = 'DATE ISSUED:'; const dateLabelWidth = doc.getTextWidth(dateLabel);
          const dateVal = dateIssuedDisp; const dateValWidth = doc.getTextWidth(dateVal);
          
          const maxLabelWidth = Math.max(dateLabelWidth, invoiceLabelWidth) + 1;
          const maxValWidth = Math.max(dateValWidth, invoiceNumWidth);
          const colWidth = maxLabelWidth + maxValWidth;
          
          const invoiceNumX = pageWidth - margin - maxValWidth;
          const invoiceLabelX = invoiceNumX - maxLabelWidth;
          const dateValX = pageWidth - margin - maxValWidth;
          const dateLabelX = dateValX - maxLabelWidth;
          
          doc.setFont('helvetica', 'bold'); doc.setFontSize(10);
          doc.setTextColor.apply(null, stone_700);
          doc.text(invoiceLabel, invoiceLabelX, currentY - 6, { align: 'left' });
          doc.text(invoiceNum, invoiceNumX, currentY - 6, { align: 'left' });
          
          doc.text(dateLabel, dateLabelX, currentY, { align: 'left' });
          doc.text(dateVal, dateValX, currentY, { align: 'left' });
      }

      dateIssuedInput.addEventListener('change', saveInvoiceData);
      if (notesInput) notesInput.addEventListener('input', () => { autoResizeTextarea(notesInput); saveInvoiceData(); });

      // [MODIFIED] New event listeners for new fields
      fromLine1.addEventListener('input', saveInvoiceData);
      fromRest.addEventListener('input', () => { syncTextareaHeights(); saveInvoiceData(); });
      clientLine1.addEventListener('input', saveInvoiceData);
      clientRest.addEventListener('input', () => { syncTextareaHeights(); saveInvoiceData(); });
      
      if (invoiceNumberInput) invoiceNumberInput.addEventListener('input', saveInvoiceData);

      // [MODIFIED] To use new address fields
      function drawPdfAddresses(doc, currentY, margin, halfPageWidth, teal_600, stone_700) {
        const fromVal = (fromLine1.value + '\n' + fromRest.value).trim();
        const clientVal = (clientLine1.value + '\n' + clientRest.value).trim();

        const fromAllLines = fromVal.split('\n'); const fromFirstLine = fromAllLines.shift() || ''; const fromRestOfLinesText = fromAllLines.join('\n');
        const clientAllLines = clientVal.split('\n'); const clientFirstLine = clientAllLines.shift() || ''; const clientRestOfLinesText = clientAllLines.join('\n');

        const labelGap = 2; // Increased gap to 2 spaces
        const columnPadding = 5;
        const addressGap = 1.5;
        const pageWidth = doc.internal.pageSize.getWidth();

        doc.setFont('helvetica', 'bold'); doc.setFontSize(12);

        // --- FROM ---
        const fromLabelText = 'FROM:';
        const fromLabelWidth = doc.getTextWidth(fromLabelText);
        // Align label to the right of its "column" (margin to halfPageWidth - columnPadding)
        const fromLabelX = halfPageWidth - columnPadding - fromLabelWidth; // Right-align label
        const fromDataX = halfPageWidth - columnPadding; // Start data right after
        const fromColumnWidth = halfPageWidth - fromDataX; // This is wrong, let's rethink

        // Simple grid: Label column and Data column
        const fromLabelColWidth = doc.getTextWidth('BILL TO:') + labelGap; // Use widest label for alignment
        const fromLabelColX = margin;
        const fromDataColX = fromLabelColX + fromLabelColWidth;
        const fromDataColWidth = (halfPageWidth - margin) - fromLabelColWidth - columnPadding;

        doc.setTextColor.apply(null, teal_600);
        doc.text(fromLabelText, fromDataColX - labelGap, currentY, { align: 'right' }); // Align right, ending at data start

        let fromBlockY = currentY;
        doc.setFontSize(11); doc.setTextColor.apply(null, stone_700);
        doc.setFont('helvetica', 'bold');
        const splitFirstFrom = doc.splitTextToSize(fromFirstLine, fromDataColWidth);
        doc.text(splitFirstFrom, fromDataColX, fromBlockY, { align: 'left' });

        let fromHeight = doc.getTextDimensions(splitFirstFrom).h;
        fromBlockY += fromHeight;
        doc.setFont('helvetica', 'normal');
        if (fromRestOfLinesText) {
          fromBlockY += addressGap;
          const splitRestFrom = doc.splitTextToSize(fromRestOfLinesText, fromDataColWidth);
          doc.text(splitRestFrom, fromDataColX, fromBlockY, { align: 'left' });
          fromHeight += doc.getTextDimensions(splitRestFrom).h + addressGap;
        }

        // --- BILL TO ---
        doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
        const toLabelText = 'BILL TO:';
        const toLabelColX = halfPageWidth + columnPadding; // Start second column
        const toDataColX = toLabelColX + fromLabelColWidth; // Use same width as 'from' label column
        const toDataColWidth = (pageWidth - margin) - toDataColX;

        doc.setTextColor.apply(null, teal_600);
        doc.text(toLabelText, toDataColX - labelGap, currentY, { align: 'right' }); // Align right

        let clientBlockY = currentY;
        doc.setFontSize(11); doc.setTextColor.apply(null, stone_700);
        doc.setFont('helvetica', 'bold');
        const splitFirstClient = doc.splitTextToSize(clientFirstLine, toDataColWidth);
        doc.text(splitFirstClient, toDataColX, clientBlockY, { align: 'left' });

        let clientHeight = doc.getTextDimensions(splitFirstClient).h;
        clientBlockY += clientHeight;
        doc.setFont('helvetica', 'normal');
        if (clientRestOfLinesText) {
          clientBlockY += addressGap;
          const splitRestClient = doc.splitTextToSize(clientRestOfLinesText, toDataColWidth);
          doc.text(splitRestClient, toDataColX, clientBlockY, { align: 'left' });
          clientHeight += doc.getTextDimensions(splitRestClient).h + addressGap;
        }

        return Math.max(fromHeight, clientHeight);
      }

      function drawPdfFooter(doc, pageNumber, pageCount, margin, pageWidth) {
        doc.setFontSize(9); doc.setTextColor.apply(null, [168, 162, 158]);
        const footerY = doc.internal.pageSize.height - 10;
        const textPart1 = ' 2025 '; const textPart2_link = 'www.AIIT.support'; const textPart3 = '. All Rights Reserved.';
        const textPart1Width = doc.getTextWidth(textPart1); const textPart2Width = doc.getTextWidth(textPart2_link);
        const linkX = margin + textPart1Width;
        doc.text(textPart1, margin, footerY); doc.text(textPart2_link, linkX, footerY); doc.text(textPart3, linkX + textPart2Width, footerY);
        doc.link(linkX, footerY - doc.getFontSize(), textPart2Width, doc.getFontSize(), { url: 'https://www.aiit.support' });
        doc.text('Page ' + pageNumber + ' of ' + pageCount, pageWidth - margin, footerY, { align: 'right' });
      }

      function exportToPdf() {
        if (!Array.isArray(window.invoiceData) || window.invoiceData.length === 0) { 
          // Use a custom modal later
          console.warn('Cannot export an empty invoice.'); 
          return; 
        }

        // --- [NEW] Commit active editor before export ---
        commitActiveEditor();

        const currentInvoiceNumber = invoiceNumberInput ? (invoiceNumberInput.value || '000') : '000';
        const theDate = dateIssuedInput.value || getTodayDateString();
        // Use T00:00:00 to avoid timezone issues
        const dateObj = new Date(theDate + 'T00:00:00');
        const dateIssuedDisp = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });


        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.setProperties({ title: `Invoice ${currentInvoiceNumber}`, subject: "Brand wordmark: www.AIIT.support. Promotional sites: AIIT.support and CustomInvoice.AI.", author: (fromLine1.value || 'AIIT.support'), keywords: 'invoice, AIIT.support, CustomInvoice.AI, billing', creator: 'AIIT Dashboard' });
        const pdfA11y = getPdfA11yEnabled(); const teal_600 = [13, 148, 136]; const stone_700 = [68, 64, 60];
        const pageWidth = doc.internal.pageSize.getWidth(); const margin = 14; const halfPageWidth = pageWidth / 2; let currentY = 22;

        // [MODIFIED] Swapped to helvetica
        drawPdfHeader(doc, currentY, margin, pageWidth, teal_600, stone_700, currentInvoiceNumber, dateIssuedDisp, undefined, pdfA11y);

        currentY += 18;
        const addressBlockHeight = drawPdfAddresses(doc, currentY, margin, halfPageWidth, teal_600, stone_700);
        let tableStartY = currentY + addressBlockHeight + 10;

        const dataRows = (window.invoiceData || []);
        const rows = dataRows.map(entry => {
            // [MODIFIED] Use parseQtyInput to match display logic
            const actualQty = parseQtyInput(String(entry.quantity), entry.unit);
            const qtyDisplay = entry.unit === 'Hrs' ? actualQty.toFixed(2) : String(parseInt(actualQty, 10));
            
            // [NEW] Handle manual total for PDF
            const isManualTotal = (String(entry.quantity).trim() === '') && (Number(entry.rate) || 0) === 0;
            const pdfTotal = isManualTotal ? (Number(entry.total) || 0) : (actualQty * (Number(entry.rate) || 0));

            return [ String(entry.description || ''), qtyDisplay, formatCurrency(entry.rate), formatCurrency(pdfTotal) ];
        });
        const grandTotal = dataRows.reduce((sum, item) => sum + (Number(item.total) || 0), 0);

        if (pdfA11y) { doc.setTextColor(120, 113, 108); doc.setFontSize(8); doc.text('Table: Invoice line items  Description; Qty/Hrs; Rate; Total.', margin, tableStartY - 2); }
        doc.autoTable({
          head: [['Description of Work', 'QTY / HRS', 'RATE', 'TOTAL']],
          body: rows,
          startY: tableStartY,
          headStyles: { fillColor: teal_600, textColor: [255, 255, 255] },
          foot: [[{ content: 'Total Amount Due:', colSpan: 3, styles: { halign: 'right', fontStyle: 'bold' } }, { content: formatCurrency(grandTotal), styles: { halign: 'right', fontStyle: 'bold' } }]],
          footStyles: { fillColor: [245, 245, 244], textColor: [28, 25, 23] },
          columnStyles: { 0: { halign: 'left',  cellWidth: 'auto' }, 1: { halign: 'right', cellWidth: 25 }, 2: { halign: 'right', cellWidth: 25 }, 3: { halign: 'right', cellWidth: 30 } },
          didParseCell(data) { if (data.section === 'head') { data.cell.styles.halign = data.column.index === 0 ? 'left' : 'right'; } },
          didDrawCell: function(data) { if (!pdfA11y) return; if (data.section === 'head') return; if (data.section === 'body' && data.column.index === 0) { try { const r = rows[data.row.index] || []; const summary = `Row ${data.row.index + 1}: ${r[0]}; Qty ${r[1]}; Rate ${r[2]}; Total ${r[3]}.`; doc.setTextColor(120,113,108); doc.setFontSize(6); doc.text(summary, data.cell.x + 0.2, data.cell.y + data.cell.height - 0.6); } catch (_) {} } }
        });

        const finalTableY = doc.lastAutoTable.finalY || tableStartY + (doc.lastAutoTable.height || 0);
        let notesY = finalTableY + 10;
        const notesValue = notesInput ? notesInput.value.trim() : '';
        const bottomMargin = 20;
        const pageHeight = doc.internal.pageSize.height;
        const labelGap = 2;

        if (notesValue) {
            const notesLabelText = "Notes / Payment Terms:";
            doc.setFont('helvetica', 'bold'); doc.setFontSize(10); doc.setTextColor.apply(null, stone_700);
            const notesLabelWidth = doc.getTextWidth(notesLabelText);
            const notesDataX = margin + notesLabelWidth + labelGap;
            const notesDataWidth = pageWidth - margin - notesDataX;
            
            const notesLines = doc.splitTextToSize(notesValue, notesDataWidth);
            const notesHeight = doc.getTextDimensions(notesLines).h + 5; // +5 for label height approx

            if (notesY + notesHeight > pageHeight - bottomMargin) {
                doc.addPage();
                notesY = margin + 10;
            }
            
            // Draw label
            doc.setFont('helvetica', 'bold'); doc.setFontSize(10); doc.setTextColor.apply(null, stone_700);
            doc.text(notesLabelText, margin, notesY);

            // Draw notes text
            doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
            doc.text(notesLines, notesDataX, notesY);
        }

        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            drawPdfFooter(doc, i, pageCount, margin, pageWidth);
        }

        doc.save(`invoice-${currentInvoiceNumber}.pdf`);

        // --- [MODIFIED BLOCK] ---
        // Removed all calls to clearInvoice()
        if (invoiceNumberInput) {
          const currentInvoiceStr = invoiceNumberInput.value; const match = currentInvoiceStr.match(/(\d+)$/);
          if (match) {
              const numberPart = match[1];
              const prefix = currentInvoiceStr.slice(0, -numberPart.length);
              const newNumberPart = String(parseInt(numberPart, 10) + 1).padStart(numberPart.length, '0');
              invoiceNumberInput.value = prefix + newNumberPart;
              saveInvoiceData(); // Save the new invoice number
            } else {
              saveInvoiceData(); // Save whatever is there
            }
        } else {
            saveInvoiceData(); // Save whatever is there
        }
        
        // Re-render to restore the active editor row, which was
        // committed (and thus removed) by commitActiveEditor()
        renderInvoice();
        // --- [END MODIFIED BLOCK] ---
      }

      function clearInvoice(resetNumber = true) {
        invoiceData = [ defaultFirstRow() ];
        
        const [from1, fromRestVal] = splitAddress(localStorage.getItem('lastFrom') || 'Your Company, Inc.');
        fromLine1.value = from1;
        fromRest.value = fromRestVal;
        
        const [client1, clientRestVal] = splitAddress(localStorage.getItem('lastClient') || 'Customer Name');
        clientLine1.value = client1;
        clientRest.value = clientRestVal;

        setNotes(localStorage.getItem('lastNotes') || '');
        dateIssuedInput.value = getTodayDateString();
        if (resetNumber && invoiceNumberInput) {
          invoiceNumberInput.value = localStorage.getItem('lastInvoiceNumber') || '001';
        }
        // [MODIFIED] Default to VISIBLE (isPreviewMode = true)
        if (!isPreviewMode) {
          isPreviewMode = true;
          previewInvoiceBtn.classList.add('active');
          previewInvoiceBtn.setAttribute('aria-pressed', 'true');
          previewInvoiceBtn.title = 'Hide Values';
          eyeIcon.classList.remove('hidden');
          maskedIcon.classList.add('hidden');
        }
        activeEditIndex = 0; // --- [NEW] Reset active editor to row 0
        renderInvoice();
      }

      if (exportPdfBtn) exportPdfBtn.addEventListener('click', exportToPdf);
      if (newInvoiceBtn) newInvoiceBtn.addEventListener('click', () => clearInvoice(true));

      // [REMOVED] Gemini Modal Listeners were here


      if (previewInvoiceBtn) {
          previewInvoiceBtn.addEventListener('click', () => {
              isPreviewMode = !isPreviewMode; // Toggle the state
              previewInvoiceBtn.setAttribute('aria-pressed', String(isPreviewMode));

              if (isPreviewMode) {
                  // Show plaintext (eye)
                  previewInvoiceBtn.classList.add('active');
                  previewInvoiceBtn.title = 'Hide Values';
                  eyeIcon.classList.remove('hidden');
                  maskedIcon.classList.add('hidden'); // [MODIFIED]
              } else {
                  // Show masked text (***)
                  previewInvoiceBtn.classList.remove('active');
                  previewInvoiceBtn.title = 'Show Values';
                  eyeIcon.classList.add('hidden');
                  maskedIcon.classList.remove('hidden'); // [MODIFIED]
              }
              
              // --- [NEW] Commit and re-render ---
              commitActiveEditor();
              renderInvoice(); 
          });
      }

      // [MODIFIED] Set initial icon state on load to VISIBLE (eye)
      isPreviewMode = true; // Default to visible
      previewInvoiceBtn.classList.add('active');
      previewInvoiceBtn.setAttribute('aria-pressed', 'true');
      previewInvoiceBtn.title = 'Hide Values';
      eyeIcon.classList.remove('hidden');
      maskedIcon.classList.add('hidden'); // [MODIFIED]
      
      initializeDashboard();

    });
  </script>

</body>
</html>


